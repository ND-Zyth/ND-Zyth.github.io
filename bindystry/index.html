<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bindustry</title>
    <style>
        html, body {
            height: 100%;
            overflow-y: hidden;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #FFFFFF;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #000000;
            line-height: 1.6;
        }

        #gamePageContainer {
            overflow: auto;
            width: 1300px;
            margin: 0 auto;
        }

        #game {
            position: absolute;
            bottom: 0;
            top: 26px;
            width: 100%;
            min-width: 1180px;
            margin: 0 auto;
            height: auto;
            white-space: nowrap;
        }

        .column {
            min-height: 100%;
            height: 100%;
            display: inline-block;
            margin-top: 4px;
            vertical-align: top;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #leftColumn {
            width: 25%;
            max-width: 400px;
            min-width: 300px;
            padding-right: 20px;
        }

        #midColumn {
            width: 630px;
            margin-top: 30px;
        }

        #rightColumn {
            min-width: 250px;
            max-width: 400px;
            padding-left: 8px;
            top: 20px;
            position: relative;
        }

        .panelContainer {
            border: 1px solid black;
            min-height: 30px;
            margin-top: 8px;
            background-color: white;
        }

        .panelContainer .title {
            padding: 4px;
            padding-left: 10px;
            font-weight: bold;
            background-color: #f5f5f5;
            border-bottom: 1px solid black;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panelContainer .container {
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .resourceRow {
            white-space: nowrap;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .resourceRow:last-child {
            border-bottom: none;
        }

        .resource-name {
            font-weight: bold;
            cursor: pointer;
        }

        .resource-value {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .resource-type {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #000;
        }

        .resource-type.solid {
            background-color: #8B4513;
        }

        .resource-type.liquid {
            background-color: #1E90FF;
        }

        .resource-type.electricity {
            background-color: #FFD700;
        }

        .btn {
            border: 1px solid black;
            padding: 8px 12px;
            cursor: default;
            text-align: center;
            margin-bottom: 10px;
            background-color: white;
            font-weight: bold;
            display: block;
            width: 100%;
            transition: all 0.2s;
        }

        .btn:hover {
            background-color: #000;
            color: white;
            cursor: pointer;
        }

        .btn.disabled {
            border-color: #cccccc;
            color: #cccccc;
            cursor: not-allowed;
        }

        .btn.disabled:hover {
            background-color: white;
            color: #cccccc;
            cursor: not-allowed;
        }

        .btn.bldEnabled {
            border: 2px solid green;
        }

        .btn.bldlackResConvert {
            border: 2px solid #FF3030;
        }

        .capacity-bar {
            height: 12px;
            background-color: #f0f0f0;
            border: 1px solid #000000;
            margin-top: 4px;
            margin-bottom: 8px;
            overflow: hidden;
            width: 100%;
        }

        .capacity-fill {
            height: 100%;
            background-color: #000000;
            width: 0%;
            transition: width 0.3s;
        }

        .factory-controls {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .control-btn {
            border: 1px solid black;
            padding: 4px 8px;
            background-color: white;
            cursor: pointer;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        .control-btn:hover:not(:disabled) {
            background-color: black;
            color: white;
        }

        .control-btn:disabled {
            border-color: #cccccc;
            color: #cccccc;
            cursor: not-allowed;
        }

        .factory-count {
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
            min-width: 60px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .boost-item {
            padding: 8px;
            margin: 6px 0;
            border: 1px solid #000000;
            background-color: #f9f9f9;
        }

        .boost-active {
            background-color: #e8f5e8;
        }

        .boost-selected {
            border: 2px solid #2196F3;
            background-color: #E3F2FD;
        }

        .boost-name {
            font-weight: bold;
        }

        .boost-description {
            font-size: 0.9rem;
            color: #333333;
            margin-top: 4px;
        }

        .stat-item {
            padding: 8px;
            border: 1px solid #000000;
            text-align: center;
            margin: 4px 0;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 4px;
        }

        .demolish-btn {
            background-color: white;
            color: #ff0000;
            border-color: #ff0000;
            margin-top: 8px;
        }

        .demolish-btn:hover {
            background-color: #ff0000;
            color: white;
        }

        .notification {
            position: fixed;
            top: 30px;
            right: 20px;
            padding: 12px 16px;
            background-color: #000000;
            color: #ffffff;
            border: 2px solid #000000;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 300px;
        }

        .notification.show {
            opacity: 1;
        }

        .spacer {
            border-bottom: 1px solid gray;
            margin-bottom: 12px;
            margin-top: 12px;
        }

        .top-controls {
            position: absolute;
            top: 2px;
            right: 10px;
            display: flex;
            gap: 8px;
        }

        .top-btn {
            border: 1px solid black;
            padding: 4px 8px;
            background-color: white;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .top-btn:hover {
            background-color: black;
            color: white;
        }

        .resLimitNotice {
            color: orange;
        }

        .resLimitWarn {
            color: coral;
        }

        .factory-info {
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .factory-inputs, .factory-outputs {
            margin: 4px 0;
        }

        .nosel {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .tab {
            text-decoration: none;
            padding: 4px 12px;
            border: 1px solid black;
            margin-right: 4px;
            background-color: white;
        }

        .tab:hover {
            background-color: black;
            color: white;
            cursor: pointer;
        }

        .activeTab {
            background-color: black;
            color: white;
        }

        .tabsContainer {
            padding-bottom: 15px;
            padding-top: 2px;
            position: absolute;
            top: 5px;
            left: 10px;
        }

        .clear {
            clear: both;
        }

        .arrow-btn {
            font-weight: bold;
            position: relative;
        }

        .arrow-btn.double::after {
            content: "↑↑";
        }

        .arrow-btn.triple::after {
            content: "↑↑↑";
        }

        .arrow-btn.double.down::after {
            content: "↓↓";
        }

        .arrow-btn.triple.down::after {
            content: "↓↓↓";
        }

        .research-progress {
            height: 4px;
            background-color: #ddd;
            margin-top: 4px;
            overflow: hidden;
        }

        .research-progress-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }

        .script-boost {
            border-color: #9C27B0;
        }

        .normal-boost {
            border-color: #2196F3;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #2196F3;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 2000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border: 3px solid black;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .filter-btn {
            padding: 4px 8px;
            border: 1px solid #ccc;
            background-color: white;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .filter-btn.active {
            background-color: black;
            color: white;
            border-color: black;
        }

        .allocation-input-group {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 8px 0;
        }

        .allocation-input {
            width: 60px;
            padding: 4px;
            border: 1px solid #333;
            text-align: center;
            font-family: 'Courier New', monospace;
        }

        .allocation-btn {
            width: 24px;
            height: 24px;
            border: 1px solid #333;
            background-color: white;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .allocation-btn:hover {
            background-color: #333;
            color: white;
        }

        .boost-selector {
            margin: 10px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
        }

        .boost-option {
            padding: 6px;
            margin: 4px 0;
            border: 1px solid #aaa;
            background-color: white;
            cursor: pointer;
        }

        .boost-option:hover {
            background-color: #f0f0f0;
        }

        .boost-option.selected {
            border-color: #2196F3;
            background-color: #e3f2fd;
        }

        .allocation-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            border: 1px solid #ddd;
            background-color: white;
        }

        .allocation-details {
            flex: 1;
            margin-right: 10px;
        }

        .mode-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .mode-description {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
        }

        .mode-stats {
            font-size: 0.8rem;
            color: #333;
        }

        .boost-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }

        .boost-section-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }

        .allocation-summary-panel {
            background-color: #f9f9f9;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            font-size: 0.9rem;
        }

        .summary-total {
            font-weight: bold;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #ccc;
        }

        .input-with-buttons {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .number-input {
            width: 50px;
            text-align: center;
            padding: 4px;
            border: 1px solid #333;
            font-family: 'Courier New', monospace;
        }

        .input-btn {
            width: 24px;
            height: 24px;
            border: 1px solid #333;
            background-color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .input-btn:hover {
            background-color: #333;
            color: white;
        }

        .boost-config {
            margin-top: 10px;
            padding: 8px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
        }

        .config-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-details {
            font-size: 0.85rem;
            color: #666;
        }

        .tag-boost-indicator {
            font-size: 0.8rem;
            color: #4CAF50;
            margin-left: 4px;
        }

        .anti-cheat-warning {
            color: #f44336;
            font-weight: bold;
            margin: 10px 0;
            padding: 8px;
            background-color: #ffebee;
            border: 1px solid #f44336;
            text-align: center;
        }

        /* Collapsible panel styles - IMPROVED */
        .factory-panel {
            margin-bottom: 10px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            overflow: hidden;
        }

        .factory-panel-header {
            padding: 12px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .factory-panel-header:hover {
            background-color: #eaeaea;
        }

        .factory-panel-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }

        .factory-panel.expanded .factory-panel-content {
            max-height: 2000px;
            padding: 15px;
            overflow: visible;
        }

        .collapse-icon {
            font-size: 1.2rem;
            transition: transform 0.3s;
            width: 20px;
            text-align: center;
        }

        .factory-panel.expanded .collapse-icon {
            transform: rotate(90deg);
        }

        .factory-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .factory-tag {
            background-color: #e0e0e0;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            color: #333;
        }

        .factory-controls-panel {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .control-section {
            margin-bottom: 15px;
        }

        .control-section-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tag-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
        }

        .tag-filter-btn {
            padding: 4px 8px;
            border: 1px solid #aaa;
            background-color: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .tag-filter-btn:hover {
            background-color: #f0f0f0;
        }

        .tag-filter-btn.active {
            background-color: #333;
            color: white;
            border-color: #333;
        }

        .global-upgrade-item {
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            background-color: white;
        }

        .global-upgrade-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .global-upgrade-description {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
        }

        .global-upgrade-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 8px;
        }

        .global-upgrade-tag {
            background-color: #e3f2fd;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            color: #1565c0;
        }

        .global-upgrade-cost {
            font-size: 0.8rem;
            color: #333;
            margin-bottom: 8px;
        }

        .upgrade-effects {
            font-size: 0.8rem;
            color: #4CAF50;
            margin-top: 4px;
        }

        .global-upgrades-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .factory-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .factory-summary-counts {
            display: flex;
            gap: 10px;
            font-size: 0.9rem;
        }

        .no-factories-message {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .factory-header-info {
            flex: 1;
        }

        .factory-header-stats {
            display: flex;
            gap: 10px;
            font-size: 0.9rem;
            color: #666;
            margin-right: 10px;
        }

        .allocation-container {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .allocation-section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1rem;
        }

        .mode-container {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .mode-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .mode-title {
            font-weight: bold;
            font-size: 1rem;
        }

        .allocation-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-details {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
        }

        .mode-io {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .mode-inputs, .mode-outputs {
            padding: 8px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .io-title {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .io-item {
            font-size: 0.8rem;
            margin-bottom: 2px;
        }

        .upgrades-container {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="gamePageContainer">
        <div id="topBar">
            <div class="tabsContainer">
                <a href="#" class="tab activeTab" id="tab-main">Main</a>
                <a href="#" class="tab" id="tab-tech">Tech Tree</a>
                <a href="#" class="tab" id="tab-global-upgrades">Global Upgrades</a>
                <a href="#" class="tab" id="tab-settings">Settings</a>
            </div>
            <div class="top-controls">
                <button class="top-btn" id="save-game">Save</button>
                <button class="top-btn" id="load-game">Load</button>
                <button class="top-btn" id="export-game">Export</button>
                <button class="top-btn" id="import-game">Import</button>
                <button class="top-btn" id="reset-game" style="color: #ff0000;">Reset</button>
            </div>
        </div>
        
        <div id="game">
            <!-- Left Column: Resources & Capacities -->
            <div id="leftColumn" class="column">
                <div class="panelContainer">
                    <div class="title">
                        <span>Resources</span>
                        <div>
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="owned">Owned</button>
                        </div>
                    </div>
                    <div class="container" id="resources-container">
                        <div id="resources-list"></div>
                    </div>
                </div>
                
                <div class="panelContainer">
                    <div class="title">Capacity</div>
                    <div class="container" id="capacity-container">
                        <div id="capacity-list"></div>
                    </div>
                </div>
                
                <div class="panelContainer">
                    <div class="title">Active Tag Boosts</div>
                    <div class="container" id="tag-boosts-container">
                        <div id="tag-boosts-list"></div>
                    </div>
                </div>
            </div>
            
            <!-- Middle Column: Research & Factory Building -->
            <div id="midColumn" class="column">
                <div class="panelContainer">
                    <div class="title">
                        <span>Tech Tree Research</span>
                        <div>
                            <button class="filter-btn active" data-filter="available">Available</button>
                            <button class="filter-btn" data-filter="all-tech">All</button>
                            <button class="filter-btn" data-filter="researched">Researched</button>
                        </div>
                    </div>
                    <div class="container" id="research-container">
                        <div id="research-list"></div>
                    </div>
                </div>
                
                <div class="panelContainer">
                    <div class="title">Build Factories</div>
                    <div class="container" id="factories-container">
                        <div id="factories-list"></div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Built Factories & Configuration -->
            <div id="rightColumn" class="column">
                <div class="panelContainer">
                    <div class="title">
                        <span>Built Factories</span>
                        <div id="tag-filter-container"></div>
                    </div>
                    <div class="container" id="built-container">
                        <div id="built-factories"></div>
                    </div>
                </div>
                
                <div class="panelContainer">
                    <div class="title">Statistics</div>
                    <div class="container">
                        <div class="stat-item">
                            <div>Total Factories</div>
                            <div class="stat-value" id="total-factories">0</div>
                        </div>
                        <div class="stat-item">
                            <div>Active Factories</div>
                            <div class="stat-value" id="active-factories">0</div>
                        </div>
                        <div class="stat-item">
                            <div>Resources/sec</div>
                            <div class="stat-value" id="resources-per-sec">0</div>
                        </div>
                        <div class="anti-cheat-warning">
                            Time Manipulation: DISABLED
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Import Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top: 0;">Import Game Data</h2>
            <textarea id="import-data" rows="10" style="width: 100%; margin: 20px 0; padding: 10px; border: 2px solid black;"></textarea>
            <div style="display: flex; justify-content: space-between;">
                <button class="btn" id="confirm-import">Import</button>
                <button class="btn demolish-btn" id="cancel-import">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top: 0;">Game Settings</h2>
            
            <div class="toggle-container">
                <span>Auto-activate new factories:</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="auto-activate-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="toggle-container">
                <span>Show all resources:</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="show-all-resources-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="toggle-container">
                <span>Show all technologies:</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="show-all-tech-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="anti-cheat-warning" style="margin: 20px 0;">
                Time speed adjustments disabled to prevent cheating
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button class="btn" id="save-settings">Save Settings</button>
                <button class="btn demolish-btn" id="close-settings">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Game Data (same as before)
        const gameData = {
            resources: {
                copper: { name: "Copper", type: "solid", initial: 50, capacity: 100 },
                iron: { name: "Iron", type: "solid", initial: 30, capacity: 100 },
                water: { name: "Water", type: "liquid", initial: 100, capacity: 100 },
                oil: { name: "Oil", type: "liquid", initial: 20, capacity: 100 },
                electricity: { name: "Electricity", type: "electricity", initial: 0, capacity: 100 },
                silicon: { name: "Silicon", type: "solid", initial: 0, capacity: 100 },
                titanium: { name: "Titanium", type: "solid", initial: 0, capacity: 100 },
                lead: { name: "Lead", type: "solid", initial: 0, capacity: 100 },
                plastic: { name: "Plastic", type: "solid", initial: 0, capacity: 100 },
                coal: { name: "Coal", type: "solid", initial: 20, capacity: 100 },
                sand: { name: "Sand", type: "solid", initial: 50, capacity: 100 },
                plastanium: { name: "Plastanium", type: "solid", initial: 0, capacity: 100 },
                uranium: { name: "Uranium", type: "solid", initial: 0, capacity: 100 },
                lithium: { name: "Lithium", type: "solid", initial: 0, capacity: 100 },
                graphite: { name: "Graphite", type: "solid", initial: 0, capacity: 100 },
                glass: { name: "Glass", type: "solid", initial: 0, capacity: 100 },
                sporePod: { name: "Spore Pod", type: "solid", initial: 0, capacity: 100 },
                blastCompound: { name: "Blast Compound", type: "solid", initial: 0, capacity: 100 },
                cryofluid: { name: "Cryofluid", type: "liquid", initial: 0, capacity: 100 },
                thorium: { name: "Thorium", type: "solid", initial: 0, capacity: 100 },
                surgeAlloy: { name: "Surge Alloy", type: "solid", initial: 0, capacity: 100 },
                phaseFabric: { name: "Phase Fabric", type: "solid", initial: 0, capacity: 100 },
                steel: { name: "Steel", type: "solid", initial: 0, capacity: 100 },
                gold: { name: "Gold", type: "solid", initial: 0, capacity: 100 },
                researchPoints: { name: "Research Points", type: "special", initial: 0, capacity: 1000 }
            },
            
            factories: {
                mechanicalDrill: {
                    name: "Mechanical Drill",
                    description: "A versatile drilling machine with multiple operational modes",
                    type: "extractor",
                    tags: ["mining", "basic", "versatile", "drilling", "extraction"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "copper_mining",
                            name: "Copper Mining",
                            description: "Extract copper ore from deposits",
                            inputs: {},
                            outputs: { copper: 1.5 },
                            cycleTime: 4,
                            basePower: 0,
                            availableUpgrades: ["water_cooling", "electric_drill", "automated_optimization"]
                        },
                        {
                            id: "iron_mining",
                            name: "Iron Mining",
                            description: "Extract iron ore from deposits",
                            inputs: {},
                            outputs: { iron: 1 },
                            cycleTime: 5,
                            basePower: 0,
                            availableUpgrades: ["water_cooling", "electric_drill", "vibration_enhancement"]
                        },
                        {
                            id: "coal_mining",
                            name: "Coal Mining",
                            description: "Extract coal from seams",
                            inputs: {},
                            outputs: { coal: 2 },
                            cycleTime: 3.5,
                            basePower: 0,
                            availableUpgrades: ["water_cooling", "electric_drill", "dust_suppression"]
                        },
                        {
                            id: "sand_extraction",
                            name: "Sand Extraction",
                            description: "Extract sand for construction",
                            inputs: {},
                            outputs: { sand: 3 },
                            cycleTime: 2.5,
                            basePower: 0,
                            availableUpgrades: ["water_cooling", "electric_drill", "fine_screening"]
                        }
                    ],
                    
                    upgrades: {
                        water_cooling: {
                            name: "Water Cooling System",
                            description: "Uses water to cool drilling equipment",
                            type: "normal",
                            requiredInputs: { water: 0.5 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0.2 }
                        },
                        electric_drill: {
                            name: "Electric Drill Head",
                            description: "Upgrade to electric drilling",
                            type: "normal",
                            requiredInputs: { electricity: 0.3 },
                            effects: { outputMultiplier: 2.2, powerIncrease: 0.3 }
                        },
                        automated_optimization: {
                            name: "Automated Optimization",
                            description: "AI-controlled optimization system",
                            type: "script",
                            requiredInputs: { electricity: 0.2, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const elecEff = Math.min(context.gameState.resources.electricity * 0.02, 0.6);
                                    const siliconEff = Math.min(context.gameState.resources.silicon * 0.03, 0.4);
                                    return 1 + elecEff + siliconEff;
                                }`,
                                powerIncrease: 0.4
                            }
                        },
                        vibration_enhancement: {
                            name: "Vibration Enhancement",
                            description: "Advanced vibration system",
                            type: "normal",
                            requiredInputs: { electricity: 0.4 },
                            effects: { outputMultiplier: 2.5, powerIncrease: 0.5 }
                        },
                        dust_suppression: {
                            name: "Dust Suppression System",
                            description: "Reduces dust in coal mining",
                            type: "normal",
                            requiredInputs: { water: 0.3 },
                            effects: { outputMultiplier: 1.6, cycleTimeReduction: 0.9, powerIncrease: 0.1 }
                        },
                        fine_screening: {
                            name: "Fine Screening",
                            description: "Improved screening for sand",
                            type: "script",
                            requiredInputs: { electricity: 0.1 },
                            effects: { 
                                script: `function(context) {
                                    const efficiency = 1 + (context.count * 0.01);
                                    return Math.min(efficiency, 1.3);
                                }`,
                                powerIncrease: 0.2
                            }
                        }
                    },
                    
                    investigationCost: { copper: 20 },
                    researchTime: 6,
                    buildCost: { copper: 30, iron: 15 },
                    capacityAdditions: { solid: 40 },
                    prerequisites: []
                },
                
                advancedFactory: {
                    name: "Advanced Factory",
                    description: "Multi-purpose manufacturing facility",
                    type: "processor",
                    tags: ["manufacturing", "advanced", "versatile", "processing", "industrial"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "steel_production",
                            name: "Steel Production",
                            description: "Produce steel from iron and coal",
                            inputs: { iron: 2, coal: 1, electricity: 0.8 },
                            outputs: { steel: 0.8 },
                            cycleTime: 10,
                            basePower: 2,
                            availableUpgrades: ["industrial_cooling", "smart_manufacturing", "quality_control"]
                        },
                        {
                            id: "glass_production",
                            name: "Glass Production",
                            description: "Produce glass from sand",
                            inputs: { sand: 3, electricity: 0.5 },
                            outputs: { glass: 1 },
                            cycleTime: 7,
                            basePower: 1.5,
                            availableUpgrades: ["industrial_cooling", "smart_manufacturing", "tempering"]
                        },
                    ],
                    
                    upgrades: {
                        industrial_cooling: {
                            name: "Industrial Cooling System",
                            description: "Advanced cooling for manufacturing",
                            type: "normal",
                            requiredInputs: { water: 1 },
                            effects: { outputMultiplier: 1.5, cycleTimeReduction: 0.95, powerIncrease: 0.3 }
                        },
                        smart_manufacturing: {
                            name: "Smart Manufacturing",
                            description: "AI-controlled production optimization",
                            type: "script",
                            requiredInputs: { electricity: 0.5, silicon: 0.1 },
                            effects: { 
                                script: `function(context) {
                                    const elecBoost = Math.min(context.gameState.resources.electricity * 0.015, 1.0);
                                    const siliconBoost = Math.min(context.gameState.resources.silicon * 0.025, 0.6);
                                    const scaleBoost = Math.min(context.count * 0.01, 0.4);
                                    return 1 + elecBoost + siliconBoost + scaleBoost;
                                }`,
                                powerIncrease: 0.5
                            }
                        },
                        quality_control: {
                            name: "Quality Control System",
                            description: "Improved quality control",
                            type: "normal",
                            requiredInputs: { electricity: 0.4 },
                            effects: { outputMultiplier: 1.3, powerIncrease: 0.2 }
                        },
                        tempering: {
                            name: "Glass Tempering",
                            description: "Advanced tempering process",
                            type: "normal",
                            requiredInputs: { electricity: 0.6 },
                            effects: { outputMultiplier: 1.4, powerIncrease: 0.3 }
                        }
                    },
                    
                    investigationCost: { copper: 120, iron: 60 },
                    researchTime: 25,
                    buildCost: { copper: 180, iron: 120, steel: 30 },
                    capacityAdditions: { solid: 120, electricity: 30 },
                    prerequisites: ["mechanicalDrill"]
                },
                
                powerPlant: {
                    name: "Power Plant",
                    description: "Generates electricity using various fuels",
                    type: "generator",
                    tags: ["power", "energy", "generation", "industrial"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "coal_power",
                            name: "Coal Power",
                            description: "Generate electricity from coal",
                            inputs: { coal: 1 },
                            outputs: { electricity: 3 },
                            cycleTime: 3,
                            basePower: 0,
                            availableUpgrades: ["high_pressure", "emission_control", "coal_efficiency"]
                        },
                        {
                            id: "oil_power",
                            name: "Oil Power",
                            description: "Generate electricity from oil",
                            inputs: { oil: 0.8 },
                            outputs: { electricity: 4 },
                            cycleTime: 2.5,
                            basePower: 0,
                            availableUpgrades: ["high_pressure", "emission_control", "combustion_optimization"]
                        }
                    ],
                    
                    upgrades: {
                        high_pressure: {
                            name: "High Pressure Turbines",
                            description: "Advanced turbine system",
                            type: "normal",
                            requiredInputs: { steel: 0.05 },
                            effects: { outputMultiplier: 1.6, powerIncrease: 0 }
                        },
                        emission_control: {
                            name: "Emission Control System",
                            description: "Reduces pollution",
                            type: "normal",
                            requiredInputs: { electricity: 0.1 },
                            effects: { outputMultiplier: 1.1, powerIncrease: 0.1 }
                        },
                        coal_efficiency: {
                            name: "Coal Efficiency Upgrade",
                            description: "Improved coal combustion",
                            type: "script",
                            requiredInputs: { electricity: 0.2 },
                            effects: { 
                                script: `function(context) {
                                    const efficiency = 1.3 + Math.min(context.gameState.resources.electricity * 0.005, 0.3);
                                    return efficiency;
                                }`,
                                powerIncrease: 0.2
                            }
                        },
                        combustion_optimization: {
                            name: "Combustion Optimization",
                            description: "Optimized oil combustion",
                            type: "normal",
                            requiredInputs: { electricity: 0.3 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0.2 }
                        }
                    },
                    
                    investigationCost: { copper: 60, iron: 30 },
                    researchTime: 12,
                    buildCost: { copper: 100, iron: 50, steel: 20 },
                    capacityAdditions: { electricity: 150 },
                    prerequisites: ["mechanicalDrill"]
                },
                
                waterPump: {
                    name: "Water Pump",
                    description: "Extracts water using different methods",
                    type: "extractor",
                    tags: ["extraction", "basic", "water", "utility"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "manual_pumping",
                            name: "Manual Pumping",
                            description: "Manual water extraction (no electricity needed)",
                            inputs: {},
                            outputs: { water: 2 },
                            cycleTime: 10,
                            basePower: 0,
                            availableUpgrades: ["high_flow", "deep_well", "filtration"]
                        },
                        {
                            id: "basic_pumping",
                            name: "Basic Pumping",
                            description: "Standard water extraction",
                            inputs: { electricity: 0.3 },
                            outputs: { water: 6 },
                            cycleTime: 6,
                            basePower: 0,
                            availableUpgrades: ["high_flow", "deep_well", "filtration"]
                        },
                        {
                            id: "high_volume",
                            name: "High Volume",
                            description: "High-volume water extraction",
                            inputs: { electricity: 0.8 },
                            outputs: { water: 12 },
                            cycleTime: 8,
                            basePower: 0,
                            availableUpgrades: ["high_flow", "deep_well", "pressure_boost"]
                        }
                    ],
                    
                    upgrades: {
                        high_flow: {
                            name: "High Flow System",
                            description: "Increased water flow rate",
                            type: "normal",
                            requiredInputs: { electricity: 0.2 },
                            effects: { outputMultiplier: 1.5, powerIncrease: 0.2 }
                        },
                        deep_well: {
                            name: "Deep Well Pumping",
                            description: "Access deeper water sources",
                            type: "normal",
                            requiredInputs: { steel: 0.1 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0.3 }
                        },
                        filtration: {
                            name: "Filtration System",
                            description: "Basic water filtration",
                            type: "normal",
                            requiredInputs: { iron: 0.05 },
                            effects: { outputMultiplier: 1.2, powerIncrease: 0.1 }
                        },
                        pressure_boost: {
                            name: "Pressure Boost",
                            description: "Increased pumping pressure",
                            type: "script",
                            requiredInputs: { electricity: 0.4 },
                            effects: { 
                                script: `function(context) {
                                    const pressure = 1.6 + Math.min(context.gameState.resources.electricity * 0.01, 0.4);
                                    return pressure;
                                }`,
                                powerIncrease: 0.4
                            }
                        }
                    },
                    
                    investigationCost: { copper: 25, iron: 15 },
                    researchTime: 9,
                    buildCost: { copper: 40, iron: 20, steel: 5 },
                    capacityAdditions: { liquid: 100 },
                    prerequisites: ["mechanicalDrill"]
                },
                
                graphitePress: {
                    name: "Graphite Press",
                    description: "Converts coal into graphite",
                    type: "processor",
                    tags: ["manufacturing", "processing", "coal", "graphite"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "graphite_production",
                            name: "Graphite Production",
                            description: "Convert coal to graphite",
                            inputs: { coal: 2, electricity: 0.5 },
                            outputs: { graphite: 1 },
                            cycleTime: 5,
                            basePower: 1.5,
                            availableUpgrades: ["water_boost", "cryofluid_boost", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        water_boost: {
                            name: "Water Boost",
                            description: "Uses water to speed up processing",
                            type: "normal",
                            requiredInputs: { water: 0.5 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0.2 }
                        },
                        cryofluid_boost: {
                            name: "Cryofluid Boost",
                            description: "Uses cryofluid for maximum efficiency",
                            type: "normal",
                            requiredInputs: { cryofluid: 0.2 },
                            effects: { outputMultiplier: 2.5, cycleTimeReduction: 0.8, powerIncrease: 0.5 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.3, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const efficiency = 1 + (context.count * 0.01);
                                    return Math.min(efficiency, 1.5);
                                }`,
                                powerIncrease: 0.3
                            }
                        }
                    },
                    
                    investigationCost: { copper: 80, iron: 40 },
                    researchTime: 15,
                    buildCost: { copper: 120, iron: 80, graphite: 20 },
                    capacityAdditions: { solid: 80 },
                    prerequisites: ["mechanicalDrill"]
                },
                
                siliconSmelter: {
                    name: "Silicon Smelter",
                    description: "Produces silicon from sand and coal with power",
                    type: "processor",
                    tags: ["manufacturing", "processing", "silicon", "smelting"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "silicon_production",
                            name: "Silicon Production",
                            description: "Smelt silicon from sand and coal",
                            inputs: { sand: 3, coal: 1, electricity: 1.2 },
                            outputs: { silicon: 1.5 },
                            cycleTime: 8,
                            basePower: 2.0,
                            availableUpgrades: ["water_cooling", "advanced_smelting", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        water_cooling: {
                            name: "Water Cooling",
                            description: "Uses water to improve smelting efficiency",
                            type: "normal",
                            requiredInputs: { water: 1 },
                            effects: { outputMultiplier: 1.6, cycleTimeReduction: 0.9, powerIncrease: 0.3 }
                        },
                        advanced_smelting: {
                            name: "Advanced Smelting",
                            description: "Advanced smelting techniques",
                            type: "normal",
                            requiredInputs: { electricity: 1.5 },
                            effects: { outputMultiplier: 2.0, powerIncrease: 0.5 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.4, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const siliconBonus = Math.min(context.gameState.resources.silicon * 0.01, 0.5);
                                    return 1.3 + siliconBonus;
                                }`,
                                powerIncrease: 0.3
                            }
                        }
                    },
                    
                    investigationCost: { copper: 100, iron: 50, coal: 30 },
                    researchTime: 18,
                    buildCost: { copper: 150, iron: 100, silicon: 20 },
                    capacityAdditions: { solid: 100 },
                    prerequisites: ["mechanicalDrill"]
                },
                
                metaglassFactory: {
                    name: "Metaglass Factory",
                    description: "Produces metaglass from sand and lead",
                    type: "processor",
                    tags: ["manufacturing", "processing", "glass", "metaglass"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "metaglass_production",
                            name: "Metaglass Production",
                            description: "Produce metaglass from sand and lead",
                            inputs: { sand: 2, lead: 2, electricity: 0.8 },
                            outputs: { glass: 1 },
                            cycleTime: 6,
                            basePower: 1.2,
                            availableUpgrades: ["water_cooling", "advanced_tempering", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        water_cooling: {
                            name: "Water Cooling",
                            description: "Uses water to improve production",
                            type: "normal",
                            requiredInputs: { water: 0.8 },
                            effects: { outputMultiplier: 1.5, cycleTimeReduction: 0.9, powerIncrease: 0.2 }
                        },
                        advanced_tempering: {
                            name: "Advanced Tempering",
                            description: "Advanced tempering process",
                            type: "normal",
                            requiredInputs: { electricity: 1.0 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0.3 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.3, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const efficiency = 1 + (context.count * 0.015);
                                    return Math.min(efficiency, 1.4);
                                }`,
                                powerIncrease: 0.2
                            }
                        }
                    },
                    
                    investigationCost: { copper: 60, iron: 30, sand: 50 },
                    researchTime: 12,
                    buildCost: { copper: 100, iron: 60, glass: 15 },
                    capacityAdditions: { solid: 100 },
                    prerequisites: ["mechanicalDrill", "waterPump"]
                },
                
                pneumaticDrill: {
                    name: "Pneumatic Drill",
                    description: "Advanced drill that can mine titanium in addition to basic resources",
                    type: "extractor",
                    tags: ["mining", "drilling", "advanced", "versatile", "extraction"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "titanium_mining",
                            name: "Titanium Mining",
                            description: "Extract titanium from deposits (slower than basic resources)",
                            inputs: { electricity: 0.8 },
                            outputs: { titanium: 0.8 },
                            cycleTime: 10,
                            basePower: 1.5,
                            availableUpgrades: ["water_cooling", "advanced_drilling", "efficiency_upgrades"]
                        },
                        {
                            id: "copper_mining",
                            name: "Copper Mining",
                            description: "Extract copper ore from deposits",
                            inputs: { electricity: 0.5 },
                            outputs: { copper: 1.2 },
                            cycleTime: 4,
                            basePower: 1.0,
                            availableUpgrades: ["water_cooling", "electric_drill", "automated_optimization"]
                        },
                        {
                            id: "iron_mining",
                            name: "Iron Mining",
                            description: "Extract iron ore from deposits",
                            inputs: { electricity: 0.5 },
                            outputs: { iron: 1.0 },
                            cycleTime: 5,
                            basePower: 1.2,
                            availableUpgrades: ["water_cooling", "electric_drill", "vibration_enhancement"]
                        },
                        {
                            id: "coal_mining",
                            name: "Coal Mining",
                            description: "Extract coal from seams",
                            inputs: { electricity: 0.4 },
                            outputs: { coal: 1.8 },
                            cycleTime: 3.5,
                            basePower: 0.8,
                            availableUpgrades: ["water_cooling", "electric_drill", "dust_suppression"]
                        },
                        {
                            id: "sand_extraction",
                            name: "Sand Extraction",
                            description: "Extract sand for construction",
                            inputs: { electricity: 0.3 },
                            outputs: { sand: 2.5 },
                            cycleTime: 2.5,
                            basePower: 0.6,
                            availableUpgrades: ["water_cooling", "electric_drill", "fine_screening"]
                        }
                    ],
                    
                    upgrades: {
                        water_cooling: {
                            name: "Water Cooling System",
                            description: "Uses water to cool drilling equipment",
                            type: "normal",
                            requiredInputs: { water: 0.5 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0.2 }
                        },
                        electric_drill: {
                            name: "Electric Drill Head",
                            description: "Upgrade to electric drilling",
                            type: "normal",
                            requiredInputs: { electricity: 0.3 },
                            effects: { outputMultiplier: 2.2, powerIncrease: 0.3 }
                        },
                        automated_optimization: {
                            name: "Automated Optimization",
                            description: "AI-controlled optimization system",
                            type: "script",
                            requiredInputs: { electricity: 0.2, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const elecEff = Math.min(context.gameState.resources.electricity * 0.02, 0.6);
                                    const siliconEff = Math.min(context.gameState.resources.silicon * 0.03, 0.4);
                                    return 1 + elecEff + siliconEff;
                                }`,
                                powerIncrease: 0.4
                            }
                        },
                        vibration_enhancement: {
                            name: "Vibration Enhancement",
                            description: "Advanced vibration system",
                            type: "normal",
                            requiredInputs: { electricity: 0.4 },
                            effects: { outputMultiplier: 2.5, powerIncrease: 0.5 }
                        },
                        dust_suppression: {
                            name: "Dust Suppression System",
                            description: "Reduces dust in coal mining",
                            type: "normal",
                            requiredInputs: { water: 0.3 },
                            effects: { outputMultiplier: 1.6, cycleTimeReduction: 0.9, powerIncrease: 0.1 }
                        },
                        fine_screening: {
                            name: "Fine Screening",
                            description: "Improved screening for sand",
                            type: "script",
                            requiredInputs: { electricity: 0.1 },
                            effects: { 
                                script: `function(context) {
                                    const efficiency = 1 + (context.count * 0.01);
                                    return Math.min(efficiency, 1.3);
                                }`,
                                powerIncrease: 0.2
                            }
                        },
                        advanced_drilling: {
                            name: "Advanced Drilling",
                            description: "Improved drilling technology",
                            type: "normal",
                            requiredInputs: { electricity: 0.5 },
                            effects: { outputMultiplier: 2.0, cycleTimeReduction: 0.9, powerIncrease: 0.4 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Overall efficiency improvements",
                            type: "script",
                            requiredInputs: { electricity: 0.3, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const countEff = Math.min(context.count * 0.02, 0.5);
                                    return 1.4 + countEff;
                                }`,
                                powerIncrease: 0.3
                            }
                        }
                    },
                    
                    investigationCost: { copper: 200, iron: 100, silicon: 50 },
                    researchTime: 20,
                    buildCost: { copper: 300, iron: 200, silicon: 50, graphite: 30, copper: 40 },
                    capacityAdditions: { solid: 60 },
                    prerequisites: ["mechanicalDrill", "graphitePress", "siliconSmelter"]
                },
                
                oilExtractor: {
                    name: "Oil Extractor",
                    description: "Extracts oil from sand and water",
                    type: "processor",
                    tags: ["extraction", "oil", "liquid", "processing"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "oil_extraction",
                            name: "Oil Extraction",
                            description: "Extract oil from sand and water slowly",
                            inputs: { sand: 4, water: 2, electricity: 1.0 },
                            outputs: { oil: 1.2 },
                            cycleTime: 12,
                            basePower: 2.0,
                            availableUpgrades: ["water_boost", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        water_boost: {
                            name: "Water Boost",
                            description: "Uses more water to improve extraction",
                            type: "normal",
                            requiredInputs: { water: 1.0 },
                            effects: { outputMultiplier: 1.5, cycleTimeReduction: 0.9, powerIncrease: 0.3 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.5, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const waterBonus = Math.min(context.gameState.resources.water * 0.005, 0.5);
                                    return 1.2 + waterBonus;
                                }`,
                                powerIncrease: 0.3
                            }
                        }
                    },
                    
                    investigationCost: { copper: 150, iron: 80, water: 100 },
                    researchTime: 25,
                    buildCost: { copper: 250, iron: 150, steel: 50 },
                    capacityAdditions: { liquid: 150 },
                    prerequisites: ["mechanicalDrill", "waterPump"]
                },
                
                sporePodFarm: {
                    name: "Spore Pod Farm",
                    description: "Produces spore pods using water input",
                    type: "processor",
                    tags: ["agriculture", "spore", "processing"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "spore_production",
                            name: "Spore Pod Production",
                            description: "Produce spore pods with water",
                            inputs: { water: 1.5, electricity: 0.6 },
                            outputs: { sporePod: 0.8 },
                            cycleTime: 10,
                            basePower: 1.2,
                            availableUpgrades: ["water_boost", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        water_boost: {
                            name: "Water Boost",
                            description: "Uses more water to improve production",
                            type: "normal",
                            requiredInputs: { water: 1.0 },
                            effects: { outputMultiplier: 1.6, cycleTimeReduction: 0.85, powerIncrease: 0.2 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.3, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const waterBonus = Math.min(context.gameState.resources.water * 0.008, 0.6);
                                    return 1.3 + waterBonus;
                                }`,
                                powerIncrease: 0.2
                            }
                        }
                    },
                    
                    investigationCost: { water: 200, researchPoints: 50 },
                    researchTime: 15,
                    buildCost: { copper: 200, iron: 120, water: 100 },
                    capacityAdditions: { solid: 100 },
                    prerequisites: ["waterPump"]
                },
                
                blastCompoundFactory: {
                    name: "Blast Compound Factory",
                    description: "Produces blast compound from spore pods, water, sand, coal and lead",
                    type: "processor",
                    tags: ["processing", "explosives", "chemical"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "blast_compound_production",
                            name: "Blast Compound Production",
                            description: "Produce blast compound using multiple ingredients",
                            inputs: { sporePod: 1, water: 1, sand: 2, coal: 2, lead: 1, electricity: 1.5 },
                            outputs: { blastCompound: 1.5 },
                            cycleTime: 15,
                            basePower: 3.0,
                            availableUpgrades: ["water_boost", "advanced_mixing", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        water_boost: {
                            name: "Water Boost",
                            description: "Uses more water to improve production",
                            type: "normal",
                            requiredInputs: { water: 1.0 },
                            effects: { outputMultiplier: 1.4, cycleTimeReduction: 0.9, powerIncrease: 0.2 }
                        },
                        advanced_mixing: {
                            name: "Advanced Mixing",
                            description: "Improved mixing process",
                            type: "normal",
                            requiredInputs: { electricity: 1.0 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0.3 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.5, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const efficiency = 1 + (context.count * 0.01);
                                    return Math.min(efficiency, 1.6);
                                }`,
                                powerIncrease: 0.3
                            }
                        }
                    },
                    
                    investigationCost: { sporePod: 10, water: 50, sand: 100, coal: 100, lead: 50 },
                    researchTime: 20,
                    buildCost: { copper: 400, iron: 300, steel: 100 },
                    capacityAdditions: { solid: 200 },
                    prerequisites: ["sporePodFarm", "graphitePress", "metaglassFactory"]
                },
                
                cryofluidMixer: {
                    name: "Cryofluid Mixer",
                    description: "Produces cryofluid from water and titanium",
                    type: "processor",
                    tags: ["processing", "cooling", "liquid"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "cryofluid_production",
                            name: "Cryofluid Production",
                            description: "Mix water and titanium to create cryofluid",
                            inputs: { water: 3, titanium: 1, electricity: 2.0 },
                            outputs: { cryofluid: 1.0 },
                            cycleTime: 8,
                            basePower: 2.5,
                            availableUpgrades: ["water_boost", "advanced_cooling", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        water_boost: {
                            name: "Water Boost",
                            description: "Uses more water to improve production",
                            type: "normal",
                            requiredInputs: { water: 1.0 },
                            effects: { outputMultiplier: 1.5, cycleTimeReduction: 0.8, powerIncrease: 0.2 }
                        },
                        advanced_cooling: {
                            name: "Advanced Cooling",
                            description: "Improved cooling process",
                            type: "normal",
                            requiredInputs: { electricity: 1.0 },
                            effects: { outputMultiplier: 1.8, cycleTimeReduction: 0.7, powerIncrease: 0.2 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.4, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const titaniumBonus = Math.min(context.gameState.resources.titanium * 0.01, 0.5);
                                    return 1.3 + titaniumBonus;
                                }`,
                                powerIncrease: 0.3
                            }
                        }
                    },
                    
                    investigationCost: { water: 100, titanium: 20 },
                    researchTime: 25,
                    buildCost: { copper: 350, iron: 250, titanium: 30 },
                    capacityAdditions: { liquid: 150 },
                    prerequisites: ["pneumaticDrill"]
                },
                
                blastDrill: {
                    name: "Blast Drill",
                    description: "Advanced drill that requires blast compound and cryofluid to mine efficiently, can mine thorium",
                    type: "extractor",
                    tags: ["mining", "drilling", "advanced", "explosive", "extraction"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "thorium_mining",
                            name: "Thorium Mining",
                            description: "Extract thorium from deposits",
                            inputs: { blastCompound: 0.2, cryofluid: 0.3, electricity: 2.0 },
                            outputs: { thorium: 0.6 },
                            cycleTime: 12,
                            basePower: 4.0,
                            availableUpgrades: ["water_cooling", "advanced_drilling", "efficiency_upgrades"]
                        },
                        {
                            id: "titanium_mining",
                            name: "Titanium Mining",
                            description: "Extract titanium from deposits",
                            inputs: { blastCompound: 0.1, cryofluid: 0.2, electricity: 1.5 },
                            outputs: { titanium: 1.0 },
                            cycleTime: 8,
                            basePower: 3.0,
                            availableUpgrades: ["water_cooling", "advanced_drilling", "efficiency_upgrades"]
                        },
                        {
                            id: "copper_mining",
                            name: "Copper Mining",
                            description: "Extract copper ore from deposits",
                            inputs: { blastCompound: 0.05, cryofluid: 0.1, electricity: 1.0 },
                            outputs: { copper: 2.5 },
                            cycleTime: 3,
                            basePower: 2.0,
                            availableUpgrades: ["water_cooling", "electric_drill", "automated_optimization"]
                        },
                        {
                            id: "iron_mining",
                            name: "Iron Mining",
                            description: "Extract iron ore from deposits",
                            inputs: { blastCompound: 0.05, cryofluid: 0.1, electricity: 1.2 },
                            outputs: { iron: 2.0 },
                            cycleTime: 3.5,
                            basePower: 2.2,
                            availableUpgrades: ["water_cooling", "electric_drill", "vibration_enhancement"]
                        },
                        {
                            id: "coal_mining",
                            name: "Coal Mining",
                            description: "Extract coal from seams",
                            inputs: { blastCompound: 0.05, cryofluid: 0.1, electricity: 0.8 },
                            outputs: { coal: 3.0 },
                            cycleTime: 2.5,
                            basePower: 1.8,
                            availableUpgrades: ["water_cooling", "electric_drill", "dust_suppression"]
                        },
                        {
                            id: "sand_extraction",
                            name: "Sand Extraction",
                            description: "Extract sand for construction",
                            inputs: { blastCompound: 0.05, cryofluid: 0.1, electricity: 0.6 },
                            outputs: { sand: 5.0 },
                            cycleTime: 1.5,
                            basePower: 1.6,
                            availableUpgrades: ["water_cooling", "electric_drill", "fine_screening"]
                        }
                    ],
                    
                    upgrades: {
                        water_cooling: {
                            name: "Water Cooling System",
                            description: "Uses water to cool drilling equipment",
                            type: "normal",
                            requiredInputs: { water: 0.5 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0.2 }
                        },
                        electric_drill: {
                            name: "Electric Drill Head",
                            description: "Upgrade to electric drilling",
                            type: "normal",
                            requiredInputs: { electricity: 0.3 },
                            effects: { outputMultiplier: 2.2, powerIncrease: 0.3 }
                        },
                        automated_optimization: {
                            name: "Automated Optimization",
                            description: "AI-controlled optimization system",
                            type: "script",
                            requiredInputs: { electricity: 0.2, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const elecEff = Math.min(context.gameState.resources.electricity * 0.02, 0.6);
                                    const siliconEff = Math.min(context.gameState.resources.silicon * 0.03, 0.4);
                                    return 1 + elecEff + siliconEff;
                                }`,
                                powerIncrease: 0.4
                            }
                        },
                        vibration_enhancement: {
                            name: "Vibration Enhancement",
                            description: "Advanced vibration system",
                            type: "normal",
                            requiredInputs: { electricity: 0.4 },
                            effects: { outputMultiplier: 2.5, powerIncrease: 0.5 }
                        },
                        dust_suppression: {
                            name: "Dust Suppression System",
                            description: "Reduces dust in coal mining",
                            type: "normal",
                            requiredInputs: { water: 0.3 },
                            effects: { outputMultiplier: 1.6, cycleTimeReduction: 0.9, powerIncrease: 0.1 }
                        },
                        fine_screening: {
                            name: "Fine Screening",
                            description: "Improved screening for sand",
                            type: "script",
                            requiredInputs: { electricity: 0.1 },
                            effects: { 
                                script: `function(context) {
                                    const efficiency = 1 + (context.count * 0.01);
                                    return Math.min(efficiency, 1.3);
                                }`,
                                powerIncrease: 0.2
                            }
                        },
                        advanced_drilling: {
                            name: "Advanced Drilling",
                            description: "Improved drilling technology",
                            type: "normal",
                            requiredInputs: { electricity: 0.5 },
                            effects: { outputMultiplier: 2.0, cycleTimeReduction: 0.9, powerIncrease: 0.4 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Overall efficiency improvements",
                            type: "script",
                            requiredInputs: { electricity: 0.3, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const countEff = Math.min(context.count * 0.02, 0.5);
                                    return 1.4 + countEff;
                                }`,
                                powerIncrease: 0.3
                            }
                        }
                    },
                    
                    investigationCost: { blastCompound: 50, cryofluid: 30, researchPoints: 200 },
                    researchTime: 35,
                    buildCost: { copper: 800, iron: 600, blastCompound: 40, cryofluid: 20 },
                    capacityAdditions: { solid: 120 },
                    prerequisites: ["blastCompoundFactory", "cryofluidMixer", "pneumaticDrill"]
                },
                
                alloyFactory: {
                    name: "Alloy Factory",
                    description: "Produces surge alloy from silicon, lead, copper and titanium, can be boosted by cryofluid",
                    type: "processor",
                    tags: ["manufacturing", "processing", "alloy", "advanced"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "surge_alloy_production",
                            name: "Surge Alloy Production",
                            description: "Produce high-grade surge alloy",
                            inputs: { silicon: 2, lead: 3, copper: 3, titanium: 2, electricity: 3.0 },
                            outputs: { surgeAlloy: 1.0 },
                            cycleTime: 20,
                            basePower: 4.0,
                            availableUpgrades: ["cryofluid_boost", "advanced_alloying", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        cryofluid_boost: {
                            name: "Cryofluid Boost",
                            description: "Uses cryofluid to improve alloy production",
                            type: "normal",
                            requiredInputs: { cryofluid: 0.5 },
                            effects: { outputMultiplier: 2.0, cycleTimeReduction: 0.7, powerIncrease: 1.0 }
                        },
                        advanced_alloying: {
                            name: "Advanced Alloying",
                            description: "Improved alloying process",
                            type: "normal",
                            requiredInputs: { electricity: 2.0 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0.5 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.6, silicon: 0.1 },
                            effects: { 
                                script: `function(context) {
                                    const surgeBonus = Math.min(context.gameState.resources.surgeAlloy * 0.02, 0.8);
                                    return 1.4 + surgeBonus;
                                }`,
                                powerIncrease: 0.4
                            }
                        }
                    },
                    
                    investigationCost: { silicon: 100, lead: 100, copper: 100, titanium: 50 },
                    researchTime: 40,
                    buildCost: { copper: 1200, iron: 800, silicon: 200, lead: 150, copper: 150, titanium: 100 },
                    capacityAdditions: { solid: 200 },
                    prerequisites: ["blastDrill", "cryofluidMixer"]
                },
                
                plastaniumCompressor: {
                    name: "Plastanium Compressor",
                    description: "Produces plastanium from titanium, oil and water",
                    type: "processor",
                    tags: ["manufacturing", "processing", "plastanium", "advanced"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "plastanium_production",
                            name: "Plastanium Production",
                            description: "Compress titanium, oil and water into plastanium",
                            inputs: { titanium: 1, oil: 2, water: 2, electricity: 2.5 },
                            outputs: { plastanium: 0.8 },
                            cycleTime: 15,
                            basePower: 3.5,
                            availableUpgrades: ["water_boost", "advanced_compression", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        water_boost: {
                            name: "Water Boost",
                            description: "Uses more water to improve compression",
                            type: "normal",
                            requiredInputs: { water: 1.0 },
                            effects: { outputMultiplier: 1.5, cycleTimeReduction: 0.85, powerIncrease: 0.2 }
                        },
                        advanced_compression: {
                            name: "Advanced Compression",
                            description: "Improved compression process",
                            type: "normal",
                            requiredInputs: { electricity: 1.5 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0.3 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.5, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const plastaniumBonus = Math.min(context.gameState.resources.plastanium * 0.015, 0.6);
                                    return 1.3 + plastaniumBonus;
                                }`,
                                powerIncrease: 0.3
                            }
                        }
                    },
                    
                    investigationCost: { titanium: 80, oil: 100, water: 100 },
                    researchTime: 30,
                    buildCost: { copper: 1000, iron: 700, titanium: 80, oil: 100, water: 100 },
                    capacityAdditions: { solid: 150 },
                    prerequisites: ["oilExtractor", "pneumaticDrill"]
                },
                
                phaseWeaver: {
                    name: "Phase Fabric Weaver",
                    description: "Weaves phase fabric using water, thorium and sand",
                    type: "processor",
                    tags: ["manufacturing", "processing", "phase", "advanced"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "phase_fabric_production",
                            name: "Phase Fabric Production",
                            description: "Weave phase fabric from water, thorium and sand",
                            inputs: { water: 1.5, thorium: 1, sand: 3, electricity: 2.0 },
                            outputs: { phaseFabric: 0.5 },
                            cycleTime: 18,
                            basePower: 3.0,
                            availableUpgrades: ["water_boost", "advanced_weaving", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        water_boost: {
                            name: "Water Boost",
                            description: "Uses more water to improve weaving",
                            type: "normal",
                            requiredInputs: { water: 1.0 },
                            effects: { outputMultiplier: 1.4, cycleTimeReduction: 0.85, powerIncrease: 0.2 }
                        },
                        advanced_weaving: {
                            name: "Advanced Weaving",
                            description: "Improved weaving process",
                            type: "normal",
                            requiredInputs: { electricity: 1.5 },
                            effects: { outputMultiplier: 1.7, powerIncrease: 0.3 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.5, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const phaseBonus = Math.min(context.gameState.resources.phaseFabric * 0.03, 0.7);
                                    return 1.3 + phaseBonus;
                                }`,
                                powerIncrease: 0.3
                            }
                        }
                    },
                    
                    investigationCost: { water: 100, thorium: 50, sand: 200 },
                    researchTime: 35,
                    buildCost: { copper: 1500, iron: 1000, thorium: 100 },
                    capacityAdditions: { solid: 180 },
                    prerequisites: ["alloyFactory", "blastDrill"]
                },
                
                laserDrill: {
                    name: "Laser Drill",
                    description: "Advanced laser drill that mines everything much more efficiently, requires significant power",
                    type: "extractor",
                    tags: ["mining", "drilling", "advanced", "laser", "extraction"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "thorium_mining",
                            name: "Thorium Mining",
                            description: "Extract thorium with laser precision",
                            inputs: { electricity: 5.0 },
                            outputs: { thorium: 1.5 },
                            cycleTime: 5,
                            basePower: 6.0,
                            availableUpgrades: ["cryofluid_boost", "advanced_lasers", "efficiency_upgrades"]
                        },
                        {
                            id: "titanium_mining",
                            name: "Titanium Mining",
                            description: "Extract titanium with laser precision",
                            inputs: { electricity: 4.0 },
                            outputs: { titanium: 2.5 },
                            cycleTime: 3,
                            basePower: 5.0,
                            availableUpgrades: ["cryofluid_boost", "advanced_lasers", "efficiency_upgrades"]
                        },
                        {
                            id: "copper_mining",
                            name: "Copper Mining",
                            description: "Extract copper ore with laser precision",
                            inputs: { electricity: 2.0 },
                            outputs: { copper: 6.0 },
                            cycleTime: 1,
                            basePower: 3.0,
                            availableUpgrades: ["water_cooling", "advanced_lasers", "efficiency_upgrades"]
                        },
                        {
                            id: "iron_mining",
                            name: "Iron Mining",
                            description: "Extract iron ore with laser precision",
                            inputs: { electricity: 2.2 },
                            outputs: { iron: 5.0 },
                            cycleTime: 1.2,
                            basePower: 3.2,
                            availableUpgrades: ["water_cooling", "advanced_lasers", "efficiency_upgrades"]
                        },
                        {
                            id: "coal_mining",
                            name: "Coal Mining",
                            description: "Extract coal with laser precision",
                            inputs: { electricity: 1.8 },
                            outputs: { coal: 8.0 },
                            cycleTime: 0.8,
                            basePower: 2.8,
                            availableUpgrades: ["water_cooling", "advanced_lasers", "efficiency_upgrades"]
                        },
                        {
                            id: "sand_extraction",
                            name: "Sand Extraction",
                            description: "Extract sand with laser precision",
                            inputs: { electricity: 1.2 },
                            outputs: { sand: 12.0 },
                            cycleTime: 0.5,
                            basePower: 2.0,
                            availableUpgrades: ["water_cooling", "advanced_lasers", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        water_cooling: {
                            name: "Water Cooling System",
                            description: "Uses water to cool laser equipment",
                            type: "normal",
                            requiredInputs: { water: 1.0 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0.2 }
                        },
                        cryofluid_boost: {
                            name: "Cryofluid Boost",
                            description: "Uses cryofluid for maximum efficiency",
                            type: "normal",
                            requiredInputs: { cryofluid: 0.3 },
                            effects: { outputMultiplier: 2.5, cycleTimeReduction: 0.7, powerIncrease: 0.5 }
                        },
                        advanced_lasers: {
                            name: "Advanced Lasers",
                            description: "Improved laser technology",
                            type: "normal",
                            requiredInputs: { electricity: 1.0 },
                            effects: { outputMultiplier: 2.0, cycleTimeReduction: 0.8, powerIncrease: 0.5 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Overall efficiency improvements",
                            type: "script",
                            requiredInputs: { electricity: 0.5, silicon: 0.1, phaseFabric: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const powerBonus = Math.min(context.gameState.resources.electricity * 0.005, 0.8);
                                    return 1.5 + powerBonus;
                                }`,
                                powerIncrease: 0.3
                            }
                        }
                    },
                    
                    investigationCost: { surgeAlloy: 50, plastanium: 30, phaseFabric: 20, researchPoints: 500 },
                    researchTime: 50,
                    buildCost: { copper: 2000, iron: 1500, surgeAlloy: 100, plastanium: 80, phaseFabric: 50 },
                    capacityAdditions: { solid: 300 },
                    prerequisites: ["alloyFactory", "plastaniumCompressor", "phaseWeaver"]
                },
                
                furnace: {
                    name: "Furnace",
                    description: "Basic furnace for generating small amounts of electricity",
                    type: "generator",
                    tags: ["power", "energy", "generation", "basic"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "coal_power",
                            name: "Coal Power",
                            description: "Generate electricity from coal",
                            inputs: { coal: 0.5 },
                            outputs: { electricity: 1 },
                            cycleTime: 2,
                            basePower: 0,
                            availableUpgrades: ["efficient_burning", "advanced_vents", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        efficient_burning: {
                            name: "Efficient Burning",
                            description: "Improved combustion efficiency",
                            type: "normal",
                            requiredInputs: { electricity: 0.1 },
                            effects: { outputMultiplier: 1.5, powerIncrease: 0 }
                        },
                        advanced_vents: {
                            name: "Advanced Vents",
                            description: "Better heat management",
                            type: "normal",
                            requiredInputs: { steel: 0.05 },
                            effects: { outputMultiplier: 1.3, powerIncrease: 0.1 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.2 },
                            effects: { 
                                script: `function(context) {
                                    const efficiency = 1.2 + Math.min(context.gameState.resources.electricity * 0.005, 0.3);
                                    return efficiency;
                                }`,
                                powerIncrease: 0.1
                            }
                        }
                    },
                    
                    investigationCost: { copper: 40, iron: 20 },
                    researchTime: 8,
                    buildCost: { copper: 60, iron: 40, coal: 20 },
                    capacityAdditions: { electricity: 50 },
                    prerequisites: ["mechanicalDrill"]
                },
                
                turbine: {
                    name: "Turbine Generator",
                    description: "Generates electricity using coal and water",
                    type: "generator",
                    tags: ["power", "energy", "generation", "advanced"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "coal_water_power",
                            name: "Coal-Water Power",
                            description: "Generate electricity from coal and water",
                            inputs: { coal: 1, water: 0.5 },
                            outputs: { electricity: 5 },
                            cycleTime: 2,
                            basePower: 0,
                            availableUpgrades: ["high_pressure", "water_efficiency", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        high_pressure: {
                            name: "High Pressure Turbines",
                            description: "Advanced turbine system",
                            type: "normal",
                            requiredInputs: { steel: 0.05 },
                            effects: { outputMultiplier: 1.6, powerIncrease: 0 }
                        },
                        water_efficiency: {
                            name: "Water Efficiency",
                            description: "Improved water usage",
                            type: "normal",
                            requiredInputs: { electricity: 0.2 },
                            effects: { outputMultiplier: 1.4, powerIncrease: 0.1 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.3 },
                            effects: { 
                                script: `function(context) {
                                    const waterBonus = Math.min(context.gameState.resources.water * 0.01, 0.5);
                                    return 1.3 + waterBonus;
                                }`,
                                powerIncrease: 0.2
                            }
                        }
                    },
                    
                    investigationCost: { copper: 150, iron: 80, water: 50 },
                    researchTime: 20,
                    buildCost: { copper: 250, iron: 200, steel: 50 },
                    capacityAdditions: { electricity: 300 },
                    prerequisites: ["waterPump", "powerPlant"]
                },
                
                rtg: {
                    name: "RTG Generator",
                    description: "Radioisotope Thermoelectric Generator providing steady power",
                    type: "generator",
                    tags: ["power", "energy", "generation", "advanced"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "rtg_power",
                            name: "RTG Power",
                            description: "Generate steady electricity using radioactive materials",
                            inputs: { uranium: 0.05 },
                            outputs: { electricity: 3 },
                            cycleTime: 2,
                            basePower: 0,
                            availableUpgrades: ["uranium_efficiency", "advanced_thermocouples", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        uranium_efficiency: {
                            name: "Uranium Efficiency",
                            description: "Improved uranium usage",
                            type: "normal",
                            requiredInputs: { uranium: 0.02 },
                            effects: { outputMultiplier: 1.5, powerIncrease: 0 }
                        },
                        advanced_thermocouples: {
                            name: "Advanced Thermocouples",
                            description: "Better heat-to-electricity conversion",
                            type: "normal",
                            requiredInputs: { silicon: 0.1 },
                            effects: { outputMultiplier: 1.4, powerIncrease: 0.1 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.2, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const uraniumBonus = Math.min(context.gameState.resources.uranium * 0.02, 0.4);
                                    return 1.2 + uraniumBonus;
                                }`,
                                powerIncrease: 0.1
                            }
                        }
                    },
                    
                    investigationCost: { uranium: 30, researchPoints: 100 },
                    researchTime: 25,
                    buildCost: { copper: 400, iron: 300, uranium: 50 },
                    capacityAdditions: { electricity: 180 },
                    prerequisites: ["advancedManufacturing"]
                },
                
                thoriumReactor: {
                    name: "Thorium Reactor",
                    description: "High-output reactor using thorium as fuel",
                    type: "generator",
                    tags: ["power", "energy", "generation", "advanced", "nuclear"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "thorium_power",
                            name: "Thorium Power",
                            description: "Generate electricity from thorium",
                            inputs: { thorium: 0.2, water: 1 },
                            outputs: { electricity: 12 },
                            cycleTime: 3,
                            basePower: 0,
                            availableUpgrades: ["coolant_efficiency", "reactor_optimization", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        coolant_efficiency: {
                            name: "Coolant Efficiency",
                            description: "Improved coolant usage",
                            type: "normal",
                            requiredInputs: { water: 0.5 },
                            effects: { outputMultiplier: 1.4, powerIncrease: 0 }
                        },
                        reactor_optimization: {
                            name: "Reactor Optimization",
                            description: "Advanced reactor control",
                            type: "normal",
                            requiredInputs: { electricity: 0.5 },
                            effects: { outputMultiplier: 1.6, powerIncrease: 0.2 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.3, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const thoriumBonus = Math.min(context.gameState.resources.thorium * 0.01, 0.5);
                                    return 1.3 + thoriumBonus;
                                }`,
                                powerIncrease: 0.2
                            }
                        }
                    },
                    
                    investigationCost: { thorium: 50, researchPoints: 200 },
                    researchTime: 35,
                    buildCost: { copper: 1000, iron: 800, thorium: 100, steel: 150 },
                    capacityAdditions: { electricity: 700 },
                    prerequisites: ["blastDrill", "waterPump"]
                },
                
                blastFurnace: {
                    name: "Blast Furnace",
                    description: "High-output furnace using blast compound and coal",
                    type: "generator",
                    tags: ["power", "energy", "generation", "advanced", "explosive"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "blast_power",
                            name: "Blast Power",
                            description: "Generate high amounts of electricity using blast compound and coal",
                            inputs: { coal: 2, blastCompound: 0.3, water: 1 },
                            outputs: { electricity: 30 },
                            cycleTime: 4,
                            basePower: 0,
                            availableUpgrades: ["explosive_efficiency", "cooling_systems", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        explosive_efficiency: {
                            name: "Explosive Efficiency",
                            description: "Improved blast compound usage",
                            type: "normal",
                            requiredInputs: { blastCompound: 0.1 },
                            effects: { outputMultiplier: 1.5, powerIncrease: 0 }
                        },
                        cooling_systems: {
                            name: "Cooling Systems",
                            description: "Advanced cooling for high-output",
                            type: "normal",
                            requiredInputs: { water: 0.5 },
                            effects: { outputMultiplier: 1.4, powerIncrease: 0.1 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.5, silicon: 0.1 },
                            effects: { 
                                script: `function(context) {
                                    const blastBonus = Math.min(context.gameState.resources.blastCompound * 0.01, 0.6);
                                    return 1.3 + blastBonus;
                                }`,
                                powerIncrease: 0.2
                            }
                        }
                    },
                    
                    investigationCost: { blastCompound: 30, researchPoints: 250 },
                    researchTime: 40,
                    buildCost: { copper: 1500, iron: 1200, blastCompound: 50, steel: 200 },
                    capacityAdditions: { electricity: 1800 },
                    prerequisites: ["blastCompoundFactory", "advancedManufacturing"]
                },
                
                alloyImpactor: {
                    name: "Alloy Impactor",
                    description: "High-output generator using surge alloy and other materials",
                    type: "generator",
                    tags: ["power", "energy", "generation", "advanced", "alloy"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "alloy_power",
                            name: "Alloy Power",
                            description: "Generate electricity using surge alloy and other materials",
                            inputs: { surgeAlloy: 0.1, water: 1.5, electricity: 5 },
                            outputs: { electricity: 15 },
                            cycleTime: 3,
                            basePower: 0,
                            availableUpgrades: ["alloy_efficiency", "power_multiplication", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        alloy_efficiency: {
                            name: "Alloy Efficiency",
                            description: "Improved surge alloy usage",
                            type: "normal",
                            requiredInputs: { surgeAlloy: 0.05 },
                            effects: { outputMultiplier: 1.5, powerIncrease: 0 }
                        },
                        power_multiplication: {
                            name: "Power Multiplication",
                            description: "Multiplies power output",
                            type: "normal",
                            requiredInputs: { electricity: 1.0 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0.3 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.4, silicon: 0.1 },
                            effects: { 
                                script: `function(context) {
                                    const alloyBonus = Math.min(context.gameState.resources.surgeAlloy * 0.02, 0.7);
                                    return 1.4 + alloyBonus;
                                }`,
                                powerIncrease: 0.3
                            }
                        }
                    },
                    
                    investigationCost: { surgeAlloy: 20, researchPoints: 300 },
                    researchTime: 45,
                    buildCost: { copper: 2000, iron: 1500, surgeAlloy: 100, steel: 300 },
                    capacityAdditions: { electricity: 800 },
                    prerequisites: ["alloyFactory", "thoriumReactor"]
                },
                
                geothermalPlant: {
                    name: "Geothermal Plant",
                    description: "Generate power from geothermal energy",
                    type: "generator",
                    tags: ["power", "energy", "generation", "renewable"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "geothermal_power",
                            name: "Geothermal Power",
                            description: "Generate electricity from geothermal sources",
                            inputs: { water: 0.8 },
                            outputs: { electricity: 7 },
                            cycleTime: 2,
                            basePower: 0,
                            availableUpgrades: ["water_efficiency", "heat_extraction", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        water_efficiency: {
                            name: "Water Efficiency",
                            description: "Improved water usage",
                            type: "normal",
                            requiredInputs: { water: 0.3 },
                            effects: { outputMultiplier: 1.4, powerIncrease: 0 }
                        },
                        heat_extraction: {
                            name: "Heat Extraction",
                            description: "Advanced heat extraction",
                            type: "normal",
                            requiredInputs: { steel: 0.1 },
                            effects: { outputMultiplier: 1.5, powerIncrease: 0.1 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.2, silicon: 0.05 },
                            effects: { 
                                script: `function(context) {
                                    const waterBonus = Math.min(context.gameState.resources.water * 0.015, 0.6);
                                    return 1.3 + waterBonus;
                                }`,
                                powerIncrease: 0.1
                            }
                        }
                    },
                    
                    investigationCost: { steel: 100, researchPoints: 150 },
                    researchTime: 30,
                    buildCost: { copper: 800, iron: 600, steel: 350 },
                    capacityAdditions: { electricity: 400 },
                    prerequisites: ["advancedManufacturing", "waterPump"]
                },
                
                solarPanel: {
                    name: "Solar Panel Array",
                    description: "Generate power from solar energy (cheap but low output)",
                    type: "generator",
                    tags: ["power", "energy", "generation", "renewable", "solar"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "solar_power",
                            name: "Solar Power",
                            description: "Generate electricity from solar energy",
                            inputs: { electricity: 0.05 },
                            outputs: { electricity: 0.7 },
                            cycleTime: 1,
                            basePower: 0,
                            availableUpgrades: ["panel_efficiency", "tracking_systems", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        panel_efficiency: {
                            name: "Panel Efficiency",
                            description: "Improved solar panel efficiency",
                            type: "normal",
                            requiredInputs: { silicon: 0.05 },
                            effects: { outputMultiplier: 1.8, powerIncrease: 0 }
                        },
                        tracking_systems: {
                            name: "Tracking Systems",
                            description: "Solar tracking for maximum exposure",
                            type: "normal",
                            requiredInputs: { electricity: 0.1 },
                            effects: { outputMultiplier: 1.5, powerIncrease: 0.05 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.1, silicon: 0.02 },
                            effects: { 
                                script: `function(context) {
                                    const siliconBonus = Math.min(context.gameState.resources.silicon * 0.01, 0.4);
                                    return 1.2 + siliconBonus;
                                }`,
                                powerIncrease: 0.05
                            }
                        }
                    },
                    
                    investigationCost: { silicon: 20, copper: 50 },
                    researchTime: 10,
                    buildCost: { copper: 100, iron: 50, silicon: 30 },
                    capacityAdditions: { electricity: 40 },
                    prerequisites: ["siliconSmelter"]
                },
                
                windTurbine: {
                    name: "Wind Turbine",
                    description: "Generate power from wind energy",
                    type: "generator",
                    tags: ["power", "energy", "generation", "renewable", "wind"],
                    flexible: true,
                    
                    productionModes: [
                        {
                            id: "wind_power",
                            name: "Wind Power",
                            description: "Generate electricity from wind energy",
                            inputs: { electricity: 0.1 },
                            outputs: { electricity: 3.3 },
                            cycleTime: 1,
                            basePower: 0,
                            availableUpgrades: ["blade_efficiency", "tower_height", "efficiency_upgrades"]
                        }
                    ],
                    
                    upgrades: {
                        blade_efficiency: {
                            name: "Blade Efficiency",
                            description: "Improved blade design",
                            type: "normal",
                            requiredInputs: { iron: 0.05 },
                            effects: { outputMultiplier: 1.6, powerIncrease: 0 }
                        },
                        tower_height: {
                            name: "Tower Height",
                            description: "Taller tower for better wind",
                            type: "normal",
                            requiredInputs: { iron: 0.1 },
                            effects: { outputMultiplier: 1.4, powerIncrease: 0.05 }
                        },
                        efficiency_upgrades: {
                            name: "Efficiency Upgrades",
                            description: "Improves overall efficiency",
                            type: "script",
                            requiredInputs: { electricity: 0.1, silicon: 0.02 },
                            effects: { 
                                script: `function(context) {
                                    const ironBonus = Math.min(context.gameState.resources.iron * 0.005, 0.3);
                                    return 1.2 + ironBonus;
                                }`,
                                powerIncrease: 0.05
                            }
                        }
                    },
                    
                    investigationCost: { iron: 100, researchPoints: 50 },
                    researchTime: 15,
                    buildCost: { copper: 200, iron: 150, steel: 50 },
                    capacityAdditions: { electricity: 200 },
                    prerequisites: ["advancedManufacturing"]
                }
            },
            
            // Global Upgrades (same as before)
            globalUpgrades: {
                miningEfficiency1: {
                    id: "miningEfficiency1",
                    name: "Mining Efficiency I",
                    description: "Improves efficiency of all mining operations",
                    tags: ["mining", "extraction"],
                    cost: { researchPoints: 100 },
                    researchTime: 10,
                    prerequisites: [],
                    effect: {
                        type: "script",
                        script: `function(context) {
                            const efficiency = 1.2;
                            const factoryBonus = Math.min(context.totalFactories * 0.005, 0.1);
                            return efficiency + factoryBonus;
                        }`
                    }
                },
                
                miningEfficiency2: {
                    id: "miningEfficiency2",
                    name: "Mining Efficiency II",
                    description: "Advanced mining optimization techniques",
                    tags: ["mining", "extraction"],
                    cost: { researchPoints: 250, silicon: 50 },
                    researchTime: 20,
                    prerequisites: ["miningEfficiency1"],
                    effect: {
                        type: "script",
                        script: `function(context) {
                            const elecBonus = Math.min(context.gameState.resources.electricity * 0.002, 0.3);
                            const scaleBonus = Math.min(context.totalFactories * 0.008, 0.4);
                            return 1.4 + elecBonus + scaleBonus;
                        }`
                    }
                },
                
                powerOptimization1: {
                    id: "powerOptimization1",
                    name: "Power Optimization I",
                    description: "Improves efficiency of all power generation",
                    tags: ["power", "energy"],
                    cost: { researchPoints: 150, electricity: 200 },
                    researchTime: 15,
                    prerequisites: [],
                    effect: {
                        type: "normal",
                        outputMultiplier: 1.25,
                        powerReduction: 0.9
                    }
                },
                
                powerOptimization2: {
                    id: "powerOptimization2",
                    name: "Power Optimization II",
                    description: "Advanced power grid management",
                    tags: ["power", "energy"],
                    cost: { researchPoints: 400, silicon: 100, titanium: 50 },
                    researchTime: 30,
                    prerequisites: ["powerOptimization1"],
                    effect: {
                        type: "script",
                        script: `function(context) {
                            const totalPower = context.gameState.resources.electricity;
                            const powerBonus = Math.min(Math.log10(totalPower + 1) * 0.1, 0.5);
                            return 1.5 + powerBonus;
                        }`
                    }
                },
                
                industrialAutomation1: {
                    id: "industrialAutomation1",
                    name: "Industrial Automation I",
                    description: "Automates manufacturing processes",
                    tags: ["manufacturing", "processing", "industrial"],
                    cost: { researchPoints: 200, steel: 100 },
                    researchTime: 18,
                    prerequisites: [],
                    effect: {
                        type: "normal",
                        outputMultiplier: 1.3,
                        cycleTimeReduction: 0.95
                    }
                },
                
                industrialAutomation2: {
                    id: "industrialAutomation2",
                    name: "Industrial Automation II",
                    description: "Advanced robotic manufacturing",
                    tags: ["manufacturing", "processing", "industrial"],
                    cost: { researchPoints: 500, silicon: 200, titanium: 100 },
                    researchTime: 35,
                    prerequisites: ["industrialAutomation1"],
                    effect: {
                        type: "script",
                        script: `function(context) {
                            const siliconBonus = Math.min(context.gameState.resources.silicon * 0.003, 0.6);
                            const scaleBonus = Math.min(context.totalFactories * 0.01, 0.5);
                            return 1.6 + siliconBonus + scaleBonus;
                        }`
                    }
                },
                
                utilityEfficiency: {
                    id: "utilityEfficiency",
                    name: "Utility Efficiency",
                    description: "Improves all utility operations",
                    tags: ["utility", "basic"],
                    cost: { researchPoints: 120 },
                    researchTime: 12,
                    prerequisites: [],
                    effect: {
                        type: "normal",
                        outputMultiplier: 1.15,
                        powerReduction: 0.95
                    }
                },
                
                adaptiveSystems: {
                    id: "adaptiveSystems",
                    name: "Adaptive Systems",
                    description: "Improves all versatile factories",
                    tags: ["versatile"],
                    cost: { researchPoints: 300, silicon: 150 },
                    researchTime: 25,
                    prerequisites: [],
                    effect: {
                        type: "script",
                        script: `function(context) {
                            const modeCount = context.factory.productionModes ? context.factory.productionModes.length : 1;
                            const versatilityBonus = Math.min((modeCount - 1) * 0.1, 0.3);
                            const scaleBonus = Math.min(context.totalFactories * 0.005, 0.2);
                            return 1.2 + versatilityBonus + scaleBonus;
                        }`
                    }
                },
                
                quantumOptimization: {
                    id: "quantumOptimization",
                    name: "Quantum Optimization",
                    description: "Applies quantum computing to all advanced factories",
                    tags: ["advanced", "science"],
                    cost: { researchPoints: 1000, silicon: 500, titanium: 200 },
                    researchTime: 60,
                    prerequisites: ["industrialAutomation2", "miningEfficiency2"],
                    effect: {
                        type: "script",
                        script: `function(context) {
                            const research = context.gameState.resources.researchPoints || 0;
                            const researchBonus = Math.min(Math.log10(research + 1) * 0.2, 1.0);
                            const siliconBonus = Math.min(context.gameState.resources.silicon * 0.004, 0.8);
                            return 1.8 + researchBonus + siliconBonus;
                        }`
                    }
                },
                
                universalEfficiency: {
                    id: "universalEfficiency",
                    name: "Universal Efficiency",
                    description: "Improves efficiency of all factories",
                    tags: ["*"],
                    cost: { researchPoints: 2000, electricity: 1000, silicon: 300 },
                    researchTime: 90,
                    prerequisites: ["quantumOptimization", "powerOptimization2"],
                    effect: {
                        type: "script",
                        script: `function(context) {
                            const totalFactories = Object.values(context.gameState.builtFactories).reduce((a, b) => a + b, 0);
                            const factoryBonus = Math.min(totalFactories * 0.002, 0.5);
                            const resourceCount = Object.keys(context.gameState.resourcesEverOwned).length;
                            const diversityBonus = Math.min(resourceCount * 0.02, 0.4);
                            return 1.2 + factoryBonus + diversityBonus;
                        }`
                    }
                }
            },
            
            // Tech Tree (same as before)
            techTree: {
                basicMining: {
                    id: "basicMining",
                    name: "Basic Mining Techniques",
                    description: "Unlock efficient mining methods",
                    cost: { copper: 10 },
                    researchTime: 5,
                    prerequisites: [],
                    effects: [
                        { type: "unlock", target: "mechanicalDrill" },
                        { type: "tagBoost", targetTag: "mining", effect: { outputMultiplier: 1.1 } }
                    ]
                },
                
                powerGeneration: {
                    id: "powerGeneration",
                    name: "Power Generation",
                    description: "Learn to generate electricity",
                    cost: { copper: 30, iron: 15 },
                    researchTime: 10,
                    prerequisites: ["basicMining"],
                    effects: [
                        { type: "unlock", target: "powerPlant" },
                        { type: "tagBoost", targetTag: "power", effect: { outputMultiplier: 1.15 } }
                    ]
                },
                
                waterManagement: {
                    id: "waterManagement",
                    name: "Water Management",
                    description: "Advanced water extraction techniques",
                    cost: { copper: 20, iron: 10 },
                    researchTime: 8,
                    prerequisites: ["basicMining"],
                    effects: [
                        { type: "unlock", target: "waterPump" },
                        { type: "tagBoost", targetTag: "water", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                advancedManufacturing: {
                    id: "advancedManufacturing",
                    name: "Advanced Manufacturing",
                    description: "Unlock advanced manufacturing techniques",
                    cost: { copper: 100, iron: 50, electricity: 30 },
                    researchTime: 15,
                    prerequisites: ["powerGeneration"],
                    effects: [
                        { type: "unlock", target: "advancedFactory" },
                        { type: "tagBoost", targetTag: "manufacturing", effect: { outputMultiplier: 1.25 } }
                    ]
                },
                
                graphitePressTech: {
                    id: "graphitePressTech",
                    name: "Graphite Press Technology",
                    description: "Unlock graphite press for converting coal to graphite",
                    cost: { copper: 60, iron: 40, coal: 50 },
                    researchTime: 12,
                    prerequisites: ["basicMining"],
                    effects: [
                        { type: "unlock", target: "graphitePress" },
                        { type: "tagBoost", targetTag: "graphite", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                siliconSmelting: {
                    id: "siliconSmelting",
                    name: "Silicon Smelting",
                    description: "Learn to smelt silicon from sand and coal",
                    cost: { copper: 80, iron: 50, sand: 100, coal: 50 },
                    researchTime: 15,
                    prerequisites: ["basicMining", "waterManagement"],
                    effects: [
                        { type: "unlock", target: "siliconSmelter" },
                        { type: "tagBoost", targetTag: "silicon", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                metaglassProduction: {
                    id: "metaglassProduction",
                    name: "Metaglass Production",
                    description: "Learn to produce metaglass from sand and lead",
                    cost: { copper: 70, iron: 40, sand: 80, lead: 40 },
                    researchTime: 10,
                    prerequisites: ["basicMining"],
                    effects: [
                        { type: "unlock", target: "metaglassFactory" },
                        { type: "tagBoost", targetTag: "glass", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                pneumaticDrilling: {
                    id: "pneumaticDrilling",
                    name: "Pneumatic Drilling",
                    description: "Advanced drilling technology that can mine titanium",
                    cost: { copper: 200, iron: 150, silicon: 60, graphite: 40 },
                    researchTime: 20,
                    prerequisites: ["basicMining", "graphitePressTech", "siliconSmelting"],
                    effects: [
                        { type: "unlock", target: "pneumaticDrill" },
                        { type: "tagBoost", targetTag: "mining", effect: { outputMultiplier: 1.3 } }
                    ]
                },
                
                oilExtraction: {
                    id: "oilExtraction",
                    name: "Oil Extraction",
                    description: "Learn to extract oil from sand and water",
                    cost: { copper: 150, iron: 100, water: 150 },
                    researchTime: 25,
                    prerequisites: ["waterManagement"],
                    effects: [
                        { type: "unlock", target: "oilExtractor" },
                        { type: "tagBoost", targetTag: "oil", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                sporeCultivation: {
                    id: "sporeCultivation",
                    name: "Spore Cultivation",
                    description: "Learn to cultivate spore pods using water",
                    cost: { water: 100, researchPoints: 30 },
                    researchTime: 12,
                    prerequisites: ["waterManagement"],
                    effects: [
                        { type: "unlock", target: "sporePodFarm" },
                        { type: "tagBoost", targetTag: "spore", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                blastCompoundTech: {
                    id: "blastCompoundTech",
                    name: "Blast Compound Technology",
                    description: "Learn to produce blast compound from multiple ingredients",
                    cost: { sporePod: 15, water: 50, sand: 100, coal: 100, lead: 50 },
                    researchTime: 20,
                    prerequisites: ["sporeCultivation", "graphitePressTech", "metaglassProduction"],
                    effects: [
                        { type: "unlock", target: "blastCompoundFactory" },
                        { type: "tagBoost", targetTag: "explosives", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                cryofluidMixing: {
                    id: "cryofluidMixing",
                    name: "Cryofluid Mixing",
                    description: "Learn to produce cryofluid from water and titanium",
                    cost: { water: 100, titanium: 20, researchPoints: 100 },
                    researchTime: 25,
                    prerequisites: ["pneumaticDrilling"],
                    effects: [
                        { type: "unlock", target: "cryofluidMixer" },
                        { type: "tagBoost", targetTag: "cooling", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                blastDrilling: {
                    id: "blastDrilling",
                    name: "Blast Drilling",
                    description: "Advanced drilling using explosives and cooling",
                    cost: { blastCompound: 50, cryofluid: 30, researchPoints: 150 },
                    researchTime: 30,
                    prerequisites: ["blastCompoundTech", "cryofluidMixing", "pneumaticDrilling"],
                    effects: [
                        { type: "unlock", target: "blastDrill" },
                        { type: "tagBoost", targetTag: "mining", effect: { outputMultiplier: 1.4 } }
                    ]
                },
                
                alloyProduction: {
                    id: "alloyProduction",
                    name: "Alloy Production",
                    description: "Learn to produce high-grade surge alloy",
                    cost: { silicon: 100, lead: 100, copper: 100, titanium: 50, researchPoints: 200 },
                    researchTime: 35,
                    prerequisites: ["blastDrilling", "cryofluidMixing"],
                    effects: [
                        { type: "unlock", target: "alloyFactory" },
                        { type: "tagBoost", targetTag: "alloy", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                plastaniumTech: {
                    id: "plastaniumTech",
                    name: "Plastanium Technology",
                    description: "Learn to produce plastanium from titanium, oil and water",
                    cost: { titanium: 80, oil: 100, water: 100, researchPoints: 150 },
                    researchTime: 25,
                    prerequisites: ["oilExtraction", "pneumaticDrilling"],
                    effects: [
                        { type: "unlock", target: "plastaniumCompressor" },
                        { type: "tagBoost", targetTag: "plastanium", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                phaseWeaving: {
                    id: "phaseWeaving",
                    name: "Phase Weaving",
                    description: "Learn to weave phase fabric from water, thorium and sand",
                    cost: { water: 150, thorium: 50, sand: 200, researchPoints: 250 },
                    researchTime: 30,
                    prerequisites: ["alloyProduction", "blastDrilling"],
                    effects: [
                        { type: "unlock", target: "phaseWeaver" },
                        { type: "tagBoost", targetTag: "phase", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                laserDrilling: {
                    id: "laserDrilling",
                    name: "Laser Drilling",
                    description: "Advanced laser technology for mining",
                    cost: { surgeAlloy: 50, plastanium: 30, phaseFabric: 20, researchPoints: 400 },
                    researchTime: 40,
                    prerequisites: ["alloyProduction", "plastaniumTech", "phaseWeaving"],
                    effects: [
                        { type: "unlock", target: "laserDrill" },
                        { type: "tagBoost", targetTag: "mining", effect: { outputMultiplier: 1.6 } }
                    ]
                },
                
                furnaceTech: {
                    id: "furnaceTech",
                    name: "Furnace Technology",
                    description: "Basic furnace for generating electricity",
                    cost: { copper: 40, iron: 20, coal: 30 },
                    researchTime: 8,
                    prerequisites: ["basicMining"],
                    effects: [
                        { type: "unlock", target: "furnace" },
                        { type: "tagBoost", targetTag: "power", effect: { outputMultiplier: 1.1 } }
                    ]
                },
                
                turbineTech: {
                    id: "turbineTech",
                    name: "Turbine Technology",
                    description: "Advanced turbine generator",
                    cost: { copper: 150, iron: 100, water: 50, researchPoints: 50 },
                    researchTime: 18,
                    prerequisites: ["waterManagement", "powerGeneration"],
                    effects: [
                        { type: "unlock", target: "turbine" },
                        { type: "tagBoost", targetTag: "power", effect: { outputMultiplier: 1.15 } }
                    ]
                },
                
                rtgTech: {
                    id: "rtgTech",
                    name: "RTG Technology",
                    description: "Radioisotope Thermoelectric Generator",
                    cost: { uranium: 30, researchPoints: 100 },
                    researchTime: 20,
                    prerequisites: ["advancedManufacturing"],
                    effects: [
                        { type: "unlock", target: "rtg" },
                        { type: "tagBoost", targetTag: "power", effect: { outputMultiplier: 1.15 } }
                    ]
                },
                
                thoriumReactorTech: {
                    id: "thoriumReactorTech",
                    name: "Thorium Reactor Technology",
                    description: "High-output thorium reactor",
                    cost: { thorium: 50, researchPoints: 200 },
                    researchTime: 30,
                    prerequisites: ["blastDrilling", "waterManagement"],
                    effects: [
                        { type: "unlock", target: "thoriumReactor" },
                        { type: "tagBoost", targetTag: "power", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                blastFurnaceTech: {
                    id: "blastFurnaceTech",
                    name: "Blast Furnace Technology",
                    description: "High-output blast furnace",
                    cost: { blastCompound: 30, researchPoints: 250 },
                    researchTime: 35,
                    prerequisites: ["blastCompoundTech", "advancedManufacturing"],
                    effects: [
                        { type: "unlock", target: "blastFurnace" },
                        { type: "tagBoost", targetTag: "power", effect: { outputMultiplier: 1.25 } }
                    ]
                },
                
                alloyImpactorTech: {
                    id: "alloyImpactorTech",
                    name: "Alloy Impactor Technology",
                    description: "High-output generator using surge alloy",
                    cost: { surgeAlloy: 20, researchPoints: 300 },
                    researchTime: 40,
                    prerequisites: ["alloyProduction", "thoriumReactorTech"],
                    effects: [
                        { type: "unlock", target: "alloyImpactor" },
                        { type: "tagBoost", targetTag: "power", effect: { outputMultiplier: 1.3 } }
                    ]
                },
                
                geothermalTech: {
                    id: "geothermalTech",
                    name: "Geothermal Technology",
                    description: "Generate power from geothermal energy",
                    cost: { steel: 100, researchPoints: 150 },
                    researchTime: 25,
                    prerequisites: ["advancedManufacturing", "waterManagement"],
                    effects: [
                        { type: "unlock", target: "geothermalPlant" },
                        { type: "tagBoost", targetTag: "power", effect: { outputMultiplier: 1.2 } }
                    ]
                },
                
                solarTech: {
                    id: "solarTech",
                    name: "Solar Technology",
                    description: "Generate power from solar energy",
                    cost: { silicon: 20, copper: 50 },
                    researchTime: 10,
                    prerequisites: ["siliconSmelting"],
                    effects: [
                        { type: "unlock", target: "solarPanel" },
                        { type: "tagBoost", targetTag: "power", effect: { outputMultiplier: 1.05 } }
                    ]
                },
                
                windTech: {
                    id: "windTech",
                    name: "Wind Technology",
                    description: "Generate power from wind energy",
                    cost: { iron: 100, researchPoints: 50 },
                    researchTime: 12,
                    prerequisites: ["advancedManufacturing"],
                    effects: [
                        { type: "unlock", target: "windTurbine" },
                        { type: "tagBoost", targetTag: "power", effect: { outputMultiplier: 1.1 } }
                    ]
                },
                
                miningEfficiency3: {
                    id: "miningEfficiency3",
                    name: "Advanced Mining Efficiency",
                    description: "Further improves efficiency of all mining operations",
                    tags: ["mining", "extraction"],
                    cost: { researchPoints: 600, silicon: 200, surgeAlloy: 100 },
                    researchTime: 40,
                    prerequisites: ["miningEfficiency2", "alloyProduction"],
                    effect: {
                        type: "script",
                        script: `function(context) {
                            const efficiency = 1.6;
                            const titaniumBonus = Math.min(context.gameState.resources.titanium * 0.005, 0.4);
                            const thoriumBonus = Math.min(context.gameState.resources.thorium * 0.003, 0.3);
                            const totalBonus = efficiency + titaniumBonus + thoriumBonus;
                            return totalBonus;
                        }`
                    }
                },
                
                miningEfficiency4: {
                    id: "miningEfficiency4",
                    name: "Expert Mining Efficiency",
                    description: "Expert level mining optimization techniques",
                    tags: ["mining", "extraction"],
                    cost: { researchPoints: 1000, silicon: 400, surgeAlloy: 200, phaseFabric: 100 },
                    researchTime: 60,
                    prerequisites: ["miningEfficiency3", "phaseWeaving"],
                    effect: {
                        type: "script",
                        script: `function(context) {
                            const efficiency = 2.0;
                            const resourceBonus = Math.min(context.gameState.resources.researchPoints * 0.0001, 0.5);
                            const factoryBonus = Math.min(context.totalFactories * 0.01, 0.6);
                            return efficiency + resourceBonus + factoryBonus;
                        }`
                    }
                },
                
                powerOptimization3: {
                    id: "powerOptimization3",
                    name: "Advanced Power Optimization",
                    description: "Improves efficiency of all power generation",
                    tags: ["power", "energy"],
                    cost: { researchPoints: 800, silicon: 300, surgeAlloy: 150 },
                    researchTime: 50,
                    prerequisites: ["powerOptimization2", "alloyProduction"],
                    effect: {
                        type: "script",
                        script: `function(context) {
                            const totalPower = context.gameState.resources.electricity;
                            const powerBonus = Math.min(Math.log10(totalPower + 1) * 0.15, 0.7);
                            const surgeBonus = Math.min(context.gameState.resources.surgeAlloy * 0.005, 0.5);
                            return 1.8 + powerBonus + surgeBonus;
                        }`
                    }
                }
            },
            
            capacities: {
                solid: 100,
                liquid: 100,
                electricity: 100,
                special: 1000
            },
            
            settings: {
                autoActivateFactories: true,
                showAllResources: false,
                showAllTech: false
            }
        };

        // Game State (same as before)
        let gameState = {
            resources: {},
            resourcesEverOwned: new Set(),
            factories: {},
            techResearched: {},
            techResearching: null,
            globalUpgradesResearched: {},
            globalUpgradesResearching: null,
            researchedFactories: {},
            builtFactories: {},
            activeFactories: {},
            factoryAllocations: {},
            capacities: { ...gameData.capacities },
            resourcesPerSecond: {},
            version: "5.1",
            settings: { ...gameData.settings },
            lastUpdate: Date.now(),
            antiCheat: {
                lastTickTime: Date.now(),
                tickCount: 0,
                speedMultiplier: 1.0,
                violations: 0
            },
            tagBoosts: {},
            globalUpgradeEffects: {},
            expandedFactoryPanels: new Set(),
            selectedTagFilter: null
        };

        // Anti-cheat system (same as before)
        const AntiCheat = {
            checkTimeManipulation() {
                const now = Date.now();
                const expectedElapsed = 1000;
                const actualElapsed = now - gameState.antiCheat.lastTickTime;
                
                if (actualElapsed < 500) {
                    gameState.antiCheat.violations++;
                    console.warn(`Time manipulation detected! Violation ${gameState.antiCheat.violations}`);
                    
                    if (gameState.antiCheat.violations > 3) {
                        this.penalizePlayer();
                    }
                }
                
                gameState.antiCheat.lastTickTime = now;
            },
            
            penalizePlayer() {
                gameState.antiCheat.speedMultiplier = 0.5;
                showNotification("CHEATING DETECTED: Production reduced by 50% for 60 seconds!");
                
                setTimeout(() => {
                    gameState.antiCheat.speedMultiplier = 1.0;
                    gameState.antiCheat.violations = 0;
                    showNotification("Penalty lifted. Please play fairly!");
                }, 60000);
            },
            
            resetViolations() {
                gameState.antiCheat.violations = 0;
            }
        };

        // DOM Elements
        const resourcesList = document.getElementById('resources-list');
        const capacityList = document.getElementById('capacity-list');
        const researchList = document.getElementById('research-list');
        const factoriesList = document.getElementById('factories-list');
        const builtFactories = document.getElementById('built-factories');
        const tagBoostsList = document.getElementById('tag-boosts-list');
        const tagFilterContainer = document.getElementById('tag-filter-container');
        const totalFactoriesElement = document.getElementById('total-factories');
        const activeFactoriesElement = document.getElementById('active-factories');
        const resourcesPerSecElement = document.getElementById('resources-per-sec');
        const notification = document.getElementById('notification');

        // State variables
        let resourceFilter = 'all';
        let techFilter = 'available';
        let currentMainTab = 'main';

        // Initialize Game
        function initGame() {
            // Initialize resources
            for (const [key, resource] of Object.entries(gameData.resources)) {
                gameState.resources[key] = resource.initial;
                gameState.resourcesPerSecond[key] = 0;
                if (resource.initial > 0) {
                    gameState.resourcesEverOwned.add(key);
                }
            }
            
            // Initialize factory states
            for (const [key, factory] of Object.entries(gameData.factories)) {
                gameState.factories[key] = { ...factory };
                gameState.researchedFactories[key] = false;
                gameState.builtFactories[key] = 0;
                gameState.activeFactories[key] = 0;
                gameState.factoryAllocations[key] = {};
            }
            
            // Initialize tech states
            for (const [key, tech] of Object.entries(gameData.techTree)) {
                gameState.techResearched[key] = false;
            }
            
            // Initialize global upgrade states
            for (const [key, upgrade] of Object.entries(gameData.globalUpgrades)) {
                gameState.globalUpgradesResearched[key] = false;
            }
            
            // Mark basic techs as researched
            gameState.techResearched.basicMining = true;
            gameState.researchedFactories.mechanicalDrill = true;
            
            // Initialize tag boosts and global upgrades
            gameState.tagBoosts = {};
            gameState.globalUpgradeEffects = {};
            
            loadGame();
            updateUI();
            startGameLoop();
            setupEventListeners();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.getElementById('tab-main').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveMainTab('main');
            });
            
            document.getElementById('tab-tech').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveMainTab('tech');
            });
            
            document.getElementById('tab-global-upgrades').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveMainTab('global-upgrades');
            });
            
            document.getElementById('tab-settings').addEventListener('click', (e) => {
                e.preventDefault();
                openSettings();
            });
            
            // Game controls
            document.getElementById('save-game').addEventListener('click', saveGame);
            document.getElementById('load-game').addEventListener('click', loadGame);
            document.getElementById('reset-game').addEventListener('click', resetGame);
            document.getElementById('export-game').addEventListener('click', exportGame);
            document.getElementById('import-game').addEventListener('click', importGame);
            
            // Import modal
            document.getElementById('confirm-import').addEventListener('click', confirmImport);
            document.getElementById('cancel-import').addEventListener('click', cancelImport);
            
            // Settings
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            document.getElementById('close-settings').addEventListener('click', closeSettings);
            
            // Filter buttons
            document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filterType = this.getAttribute('data-filter');
                    const container = this.closest('.panelContainer');
                    
                    this.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    if (container.querySelector('#resources-list')) {
                        resourceFilter = filterType;
                        updateResources();
                    } else if (container.querySelector('#research-list')) {
                        techFilter = filterType;
                        updateResearch();
                    }
                });
            });
        }

        // Set active main tab
        function setActiveMainTab(tabName) {
            currentMainTab = tabName;
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('activeTab');
            });
            
            if (tabName === 'main') {
                document.getElementById('tab-main').classList.add('activeTab');
                document.getElementById('game').style.display = 'block';
                document.getElementById('tech-tree-view').style.display = 'none';
                document.getElementById('global-upgrades-view').style.display = 'none';
            } else if (tabName === 'tech') {
                document.getElementById('tab-tech').classList.add('activeTab');
                document.getElementById('game').style.display = 'none';
                if (!document.getElementById('tech-tree-view')) {
                    createTechTreeView();
                }
                document.getElementById('tech-tree-view').style.display = 'block';
                document.getElementById('global-upgrades-view').style.display = 'none';
            } else if (tabName === 'global-upgrades') {
                document.getElementById('tab-global-upgrades').classList.add('activeTab');
                document.getElementById('game').style.display = 'none';
                if (!document.getElementById('global-upgrades-view')) {
                    createGlobalUpgradesView();
                }
                document.getElementById('global-upgrades-view').style.display = 'block';
                document.getElementById('tech-tree-view').style.display = 'none';
            }
        }

        // Create tech tree view
        function createTechTreeView() {
            const techTreeDiv = document.createElement('div');
            techTreeDiv.id = 'tech-tree-view';
            techTreeDiv.style.display = 'none';
            techTreeDiv.style.position = 'absolute';
            techTreeDiv.style.top = '40px';
            techTreeDiv.style.left = '0';
            techTreeDiv.style.width = '100%';
            techTreeDiv.style.height = 'calc(100% - 40px)';
            techTreeDiv.style.overflow = 'auto';
            techTreeDiv.style.backgroundColor = 'white';
            techTreeDiv.style.padding = '20px';
            
            document.getElementById('gamePageContainer').appendChild(techTreeDiv);
        }

        // Create global upgrades view
        function createGlobalUpgradesView() {
            const upgradesDiv = document.createElement('div');
            upgradesDiv.id = 'global-upgrades-view';
            upgradesDiv.style.display = 'none';
            upgradesDiv.style.position = 'absolute';
            upgradesDiv.style.top = '40px';
            upgradesDiv.style.left = '0';
            upgradesDiv.style.width = '100%';
            upgradesDiv.style.height = 'calc(100% - 40px)';
            upgradesDiv.style.overflow = 'auto';
            upgradesDiv.style.backgroundColor = 'white';
            upgradesDiv.style.padding = '20px';
            
            document.getElementById('gamePageContainer').appendChild(upgradesDiv);
        }

        // Update tech tree view
        function updateTechTreeView() {
            const techTreeView = document.getElementById('tech-tree-view');
            if (!techTreeView) return;
            
            techTreeView.innerHTML = '<h2>Tech Tree</h2>';
            
            for (const [techId, tech] of Object.entries(gameData.techTree)) {
                const isResearched = gameState.techResearched[techId];
                const isResearching = gameState.techResearching === techId;
                const canResearch = canResearchTech(techId);
                
                const node = document.createElement('div');
                node.className = `global-upgrade-item ${isResearched ? 'researched' : isResearching ? 'researching' : canResearch ? '' : 'locked'}`;
                node.dataset.techId = techId;
                
                let costText = 'Cost: ';
                for (const [resource, amount] of Object.entries(tech.cost)) {
                    costText += `${amount} ${gameData.resources[resource]?.name || resource}, `;
                }
                costText = costText.slice(0, -2);
                
                node.innerHTML = `
                    <div class="global-upgrade-name">${tech.name} ${isResearched ? '✓' : ''}</div>
                    <div class="global-upgrade-description">${tech.description}</div>
                    <div class="global-upgrade-cost">${costText}</div>
                    <div class="global-upgrade-cost">Research Time: ${tech.researchTime}s</div>
                    ${isResearching ? '<div style="color: #FF9800; font-weight: bold;">Researching...</div>' : ''}
                `;
                
                if (!isResearched && canResearch && !isResearching) {
                    const researchBtn = document.createElement('button');
                    researchBtn.className = 'btn';
                    researchBtn.style.marginTop = '8px';
                    researchBtn.textContent = 'Research';
                    researchBtn.onclick = () => startResearchTech(techId);
                    node.appendChild(researchBtn);
                }
                
                techTreeView.appendChild(node);
            }
        }

        // Update global upgrades view
        function updateGlobalUpgradesView() {
            const upgradesView = document.getElementById('global-upgrades-view');
            if (!upgradesView) return;
            
            upgradesView.innerHTML = '<h2>Global Factory Upgrades</h2><p>These upgrades apply to all factories with matching tags.</p>';
            
            const container = document.createElement('div');
            container.className = 'global-upgrades-container';
            
            for (const [upgradeId, upgrade] of Object.entries(gameData.globalUpgrades)) {
                const isResearched = gameState.globalUpgradesResearched[upgradeId];
                const isResearching = gameState.globalUpgradesResearching === upgradeId;
                const canResearch = canResearchGlobalUpgrade(upgradeId);
                
                const upgradeElement = document.createElement('div');
                upgradeElement.className = `global-upgrade-item ${isResearched ? 'researched' : isResearching ? 'researching' : canResearch ? '' : 'locked'}`;
                
                // Tags display
                let tagsHtml = '';
                if (upgrade.tags && upgrade.tags.length > 0) {
                    tagsHtml = '<div class="global-upgrade-tags">';
                    upgrade.tags.forEach(tag => {
                        tagsHtml += `<span class="global-upgrade-tag">${tag}</span>`;
                    });
                    tagsHtml += '</div>';
                }
                
                // Cost text
                let costText = 'Cost: ';
                for (const [resource, amount] of Object.entries(upgrade.cost)) {
                    costText += `${amount} ${gameData.resources[resource]?.name || resource}, `;
                }
                costText = costText.slice(0, -2);
                
                // Effects text
                let effectsText = '';
                if (upgrade.effect.type === 'normal') {
                    if (upgrade.effect.outputMultiplier) {
                        effectsText += `Output: ×${upgrade.effect.outputMultiplier.toFixed(2)} `;
                    }
                    if (upgrade.effect.cycleTimeReduction) {
                        effectsText += `Speed: ×${upgrade.effect.cycleTimeReduction.toFixed(2)} `;
                    }
                    if (upgrade.effect.powerReduction) {
                        effectsText += `Power: ×${upgrade.effect.powerReduction.toFixed(2)}`;
                    }
                } else if (upgrade.effect.type === 'script') {
                    effectsText = 'Dynamic script-based effects';
                }
                
                upgradeElement.innerHTML = `
                    <div class="global-upgrade-name">${upgrade.name} ${isResearched ? '✓' : ''}</div>
                    <div class="global-upgrade-description">${upgrade.description}</div>
                    ${tagsHtml}
                    <div class="global-upgrade-cost">${costText}</div>
                    <div class="global-upgrade-cost">Research Time: ${upgrade.researchTime}s</div>
                    <div class="upgrade-effects">${effectsText}</div>
                    ${isResearching ? '<div style="color: #FF9800; font-weight: bold;">Researching...</div>' : ''}
                `;
                
                if (!isResearched && canResearch && !isResearching) {
                    const researchBtn = document.createElement('button');
                    researchBtn.className = 'btn';
                    researchBtn.style.marginTop = '8px';
                    researchBtn.textContent = 'Research';
                    researchBtn.onclick = () => startResearchGlobalUpgrade(upgradeId);
                    upgradeElement.appendChild(researchBtn);
                }
                
                container.appendChild(upgradeElement);
            }
            
            upgradesView.appendChild(container);
        }

        // Check if tech can be researched
        function canResearchTech(techId) {
            const tech = gameData.techTree[techId];
            if (!tech) return false;
            
            // Check prerequisites
            for (const prereq of tech.prerequisites) {
                if (!gameState.techResearched[prereq]) {
                    return false;
                }
            }
            
            // Check if already researched or researching
            if (gameState.techResearched[techId] || gameState.techResearching) {
                return false;
            }
            
            // Check resource costs
            for (const [resource, amount] of Object.entries(tech.cost)) {
                if (gameState.resources[resource] < amount) {
                    return false;
                }
            }
            
            return true;
        }

        // Check if global upgrade can be researched
        function canResearchGlobalUpgrade(upgradeId) {
            const upgrade = gameData.globalUpgrades[upgradeId];
            if (!upgrade) return false;
            
            // Check prerequisites
            for (const prereq of upgrade.prerequisites) {
                if (!gameState.globalUpgradesResearched[prereq]) {
                    return false;
                }
            }
            
            // Check if already researched or researching
            if (gameState.globalUpgradesResearched[upgradeId] || gameState.globalUpgradesResearching) {
                return false;
            }
            
            // Check resource costs
            for (const [resource, amount] of Object.entries(upgrade.cost)) {
                if (gameState.resources[resource] < amount) {
                    return false;
                }
            }
            
            return true;
        }

        // Start researching a tech
        function startResearchTech(techId) {
            if (gameState.techResearching) {
                showNotification(`Already researching ${gameData.techTree[gameState.techResearching].name}`);
                return;
            }
            
            const tech = gameData.techTree[techId];
            
            // Check costs
            for (const [resource, amount] of Object.entries(tech.cost)) {
                if (gameState.resources[resource] < amount) {
                    showNotification(`Not enough ${gameData.resources[resource]?.name || resource}`);
                    return;
                }
            }
            
            // Deduct costs
            for (const [resource, amount] of Object.entries(tech.cost)) {
                gameState.resources[resource] -= amount;
            }
            
            // Start research
            gameState.techResearching = techId;
            gameState.techResearchProgress = 0;
            gameState.techResearchTotalTime = tech.researchTime;
            
            showNotification(`Started researching: ${tech.name}`);
            updateUI();
            updateTechTreeView();
            saveGame();
        }

        // Start researching a global upgrade
        function startResearchGlobalUpgrade(upgradeId) {
            if (gameState.globalUpgradesResearching) {
                showNotification(`Already researching ${gameData.globalUpgrades[gameState.globalUpgradesResearching].name}`);
                return;
            }
            
            const upgrade = gameData.globalUpgrades[upgradeId];
            
            // Check costs
            for (const [resource, amount] of Object.entries(upgrade.cost)) {
                if (gameState.resources[resource] < amount) {
                    showNotification(`Not enough ${gameData.resources[resource]?.name || resource}`);
                    return;
                }
            }
            
            // Deduct costs
            for (const [resource, amount] of Object.entries(upgrade.cost)) {
                gameState.resources[resource] -= amount;
            }
            
            // Start research
            gameState.globalUpgradesResearching = upgradeId;
            gameState.globalUpgradesResearchProgress = 0;
            gameState.globalUpgradesResearchTotalTime = upgrade.researchTime;
            
            showNotification(`Started researching: ${upgrade.name}`);
            updateUI();
            updateGlobalUpgradesView();
            saveGame();
        }

        // Apply tech effects
        function applyTechEffects(techId) {
            const tech = gameData.techTree[techId];
            
            for (const effect of tech.effects) {
                switch (effect.type) {
                    case 'unlock':
                        if (gameData.factories[effect.target]) {
                            gameState.researchedFactories[effect.target] = true;
                        }
                        break;
                        
                    case 'tagBoost':
                        if (!gameState.tagBoosts[effect.targetTag]) {
                            gameState.tagBoosts[effect.targetTag] = [];
                        }
                        gameState.tagBoosts[effect.targetTag].push(effect.effect);
                        break;
                }
            }
        }

        // Apply global upgrade effects
        function applyGlobalUpgradeEffects(upgradeId) {
            const upgrade = gameData.globalUpgrades[upgradeId];
            
            if (!gameState.globalUpgradeEffects[upgradeId]) {
                gameState.globalUpgradeEffects[upgradeId] = {
                    tags: upgrade.tags,
                    effect: upgrade.effect
                };
            }
        }

        // Calculate global upgrades for a factory
        function calculateGlobalUpgrades(factory) {
            let outputMultiplier = 1;
            let cycleTimeMultiplier = 1;
            let powerMultiplier = 1;
            
            for (const [upgradeId, upgrade] of Object.entries(gameState.globalUpgradeEffects)) {
                // Check if factory has any of the upgrade's tags, or if upgrade applies to all factories
                if (upgrade.tags.includes('*') || factory.tags.some(tag => upgrade.tags.includes(tag))) {
                    const context = {
                        factory: factory,
                        gameState: gameState,
                        totalFactories: Object.values(gameState.builtFactories).reduce((a, b) => a + b, 0)
                    };
                    
                    if (upgrade.effect.type === 'normal') {
                        if (upgrade.effect.outputMultiplier) outputMultiplier *= upgrade.effect.outputMultiplier;
                        if (upgrade.effect.cycleTimeReduction) cycleTimeMultiplier *= upgrade.effect.cycleTimeReduction;
                        if (upgrade.effect.powerReduction) powerMultiplier *= upgrade.effect.powerReduction;
                    } else if (upgrade.effect.type === 'script') {
                        try {
                            const scriptMultiplier = evaluateGlobalUpgradeScript(upgrade.effect.script, context);
                            outputMultiplier *= scriptMultiplier;
                        } catch (e) {
                            console.error('Error evaluating global upgrade script:', e);
                        }
                    }
                }
            }
            
            return { outputMultiplier, cycleTimeMultiplier, powerMultiplier };
        }

        // Calculate tag boosts for a factory
        function calculateTagBoosts(factory) {
            let outputMultiplier = 1;
            let cycleTimeMultiplier = 1;
            let powerMultiplier = 1;
            
            if (factory.tags) {
                for (const tag of factory.tags) {
                    const boosts = gameState.tagBoosts[tag] || [];
                    for (const boost of boosts) {
                        if (boost.outputMultiplier) outputMultiplier *= boost.outputMultiplier;
                        if (boost.cycleTimeReduction) cycleTimeMultiplier *= boost.cycleTimeReduction;
                        if (boost.powerReduction) powerMultiplier *= boost.powerReduction;
                    }
                }
            }
            
            return { outputMultiplier, cycleTimeMultiplier, powerMultiplier };
        }

        // Evaluate global upgrade script
        function evaluateGlobalUpgradeScript(script, context) {
            try {
                const evalFunc = new Function('context', `
                    try {
                        ${script}
                        return evaluate(context);
                    } catch(e) {
                        console.error('Global upgrade script error:', e);
                        return 1;
                    }
                `);
                
                return evalFunc(context);
            } catch (e) {
                console.error('Global upgrade script compilation error:', e);
                return 1;
            }
        }

        // Evaluate factory upgrade script
        function evaluateUpgradeScript(script, context) {
            try {
                const evalFunc = new Function('context', `
                    try {
                        ${script}
                        return calculate(context);
                    } catch(e) {
                        console.error('Upgrade script error:', e);
                        return 1;
                    }
                `);
                
                return evalFunc(context);
            } catch (e) {
                console.error('Upgrade script compilation error:', e);
                return 1;
            }
        }

        // Start Game Loop
        function startGameLoop() {
            setInterval(gameTick, 1000);
        }

        // Game Tick (same as before)
        function gameTick() {
            AntiCheat.checkTimeManipulation();
            
            let hasChanges = false;
            let totalResourcesPerSec = 0;
            
            // Process tech research
            if (gameState.techResearching) {
                gameState.techResearchProgress++;
                
                if (gameState.techResearchProgress >= gameState.techResearchTotalTime) {
                    const techId = gameState.techResearching;
                    gameState.techResearched[techId] = true;
                    applyTechEffects(techId);
                    showNotification(`${gameData.techTree[techId].name} research completed!`);
                    gameState.techResearching = null;
                    gameState.techResearchProgress = 0;
                    hasChanges = true;
                }
            }
            
            // Process global upgrade research
            if (gameState.globalUpgradesResearching) {
                gameState.globalUpgradesResearchProgress++;
                
                if (gameState.globalUpgradesResearchProgress >= gameState.globalUpgradesResearchTotalTime) {
                    const upgradeId = gameState.globalUpgradesResearching;
                    gameState.globalUpgradesResearched[upgradeId] = true;
                    applyGlobalUpgradeEffects(upgradeId);
                    showNotification(`${gameData.globalUpgrades[upgradeId].name} research completed!`);
                    gameState.globalUpgradesResearching = null;
                    gameState.globalUpgradesResearchProgress = 0;
                    hasChanges = true;
                }
            }
            
            // Reset per-second calculations
            for (const key in gameState.resourcesPerSecond) {
                gameState.resourcesPerSecond[key] = 0;
            }
            
            // Process each factory
            for (const [factoryKey, factory] of Object.entries(gameData.factories)) {
                const builtCount = gameState.builtFactories[factoryKey];
                
                if (builtCount > 0 && factory.flexible) {
                    // Process flexible factory allocations
                    const allocations = gameState.factoryAllocations[factoryKey] || {};
                    const tagBoosts = calculateTagBoosts(factory);
                    const globalUpgrades = calculateGlobalUpgrades(factory);
                    
                    for (const [modeId, allocation] of Object.entries(allocations)) {
                        const mode = factory.productionModes.find(m => m.id === modeId);
                        if (!mode || allocation.count <= 0) continue;
                        
                        // Calculate upgrade multipliers
                        let upgradeOutputMultiplier = 1;
                        let upgradeCycleMultiplier = 1;
                        let totalPower = mode.basePower;
                        
                        // Apply selected upgrades
                        for (const upgradeId of allocation.selectedUpgrades || []) {
                            const upgrade = factory.upgrades[upgradeId];
                            if (!upgrade) continue;
                            
                            // Check if we have resources for this upgrade
                            let canApplyUpgrade = true;
                            for (const [resource, amount] of Object.entries(upgrade.requiredInputs)) {
                                const totalNeeded = amount * allocation.count;
                                if (gameState.resources[resource] < totalNeeded) {
                                    canApplyUpgrade = false;
                                    break;
                                }
                            }
                            
                            if (canApplyUpgrade) {
                                // Apply upgrade effects
                                if (upgrade.type === 'script' && upgrade.effects.script) {
                                    const context = {
                                        gameState: gameState,
                                        count: allocation.count,
                                        factory: factory
                                    };
                                    const scriptMultiplier = evaluateUpgradeScript(upgrade.effects.script, context);
                                    upgradeOutputMultiplier *= scriptMultiplier;
                                } else {
                                    if (upgrade.effects.outputMultiplier) {
                                        upgradeOutputMultiplier *= upgrade.effects.outputMultiplier;
                                    }
                                    if (upgrade.effects.cycleTimeReduction) {
                                        upgradeCycleMultiplier *= upgrade.effects.cycleTimeReduction;
                                    }
                                }
                                
                                // Add power consumption
                                if (upgrade.effects.powerIncrease) {
                                    totalPower += upgrade.effects.powerIncrease;
                                }
                                
                                // Consume upgrade resources
                                for (const [resource, amount] of Object.entries(upgrade.requiredInputs)) {
                                    const totalNeeded = amount * allocation.count;
                                    gameState.resources[resource] -= totalNeeded;
                                    gameState.resourcesPerSecond[resource] -= totalNeeded / mode.cycleTime;
                                }
                            }
                        }
                        
                        // Apply all multipliers
                        const finalOutputMultiplier = upgradeOutputMultiplier * tagBoosts.outputMultiplier * globalUpgrades.outputMultiplier;
                        const finalCycleMultiplier = tagBoosts.cycleTimeMultiplier * upgradeCycleMultiplier * globalUpgrades.cycleTimeMultiplier;
                        const finalPower = totalPower * tagBoosts.powerMultiplier * globalUpgrades.powerMultiplier;
                        
                        // Check if we have enough resources for production
                        let canProduce = true;
                        for (const [inputKey, inputAmount] of Object.entries(mode.inputs)) {
                            const totalInputNeeded = inputAmount * allocation.count;
                            if (gameState.resources[inputKey] < totalInputNeeded) {
                                canProduce = false;
                                break;
                            }
                        }
                        
                        // Check power requirements
                        if (finalPower > 0) {
                            const totalPowerNeeded = finalPower * allocation.count;
                            if (gameState.resources.electricity < totalPowerNeeded) {
                                canProduce = false;
                            }
                        }
                        
                        if (canProduce) {
                            // Consume inputs
                            for (const [inputKey, inputAmount] of Object.entries(mode.inputs)) {
                                const totalInputNeeded = inputAmount * allocation.count;
                                gameState.resources[inputKey] -= totalInputNeeded;
                                gameState.resourcesPerSecond[inputKey] -= totalInputNeeded / mode.cycleTime;
                            }
                            
                            // Consume power
                            if (finalPower > 0) {
                                const totalPowerNeeded = finalPower * allocation.count;
                                gameState.resources.electricity -= totalPowerNeeded;
                                gameState.resourcesPerSecond.electricity -= totalPowerNeeded / mode.cycleTime;
                            }
                            
                            // Produce outputs
                            for (const [outputKey, outputAmount] of Object.entries(mode.outputs)) {
                                const totalOutput = outputAmount * allocation.count * finalOutputMultiplier;
                                const resourceType = gameData.resources[outputKey].type;
                                const capacity = gameState.capacities[resourceType];
                                
                                gameState.resourcesPerSecond[outputKey] += totalOutput / (mode.cycleTime * finalCycleMultiplier);
                                totalResourcesPerSec += totalOutput / (mode.cycleTime * finalCycleMultiplier);
                                
                                if (totalOutput > 0) {
                                    gameState.resourcesEverOwned.add(outputKey);
                                }
                                
                                if (gameState.resources[outputKey] + totalOutput <= capacity) {
                                    gameState.resources[outputKey] += totalOutput;
                                } else {
                                    gameState.resources[outputKey] = capacity;
                                }
                            }
                            
                            hasChanges = true;
                        }
                    }
                }
            }
            
            // Apply anti-cheat speed multiplier
            if (gameState.antiCheat.speedMultiplier !== 1.0) {
                for (const key in gameState.resourcesPerSecond) {
                    gameState.resourcesPerSecond[key] *= gameState.antiCheat.speedMultiplier;
                }
                totalResourcesPerSec *= gameState.antiCheat.speedMultiplier;
            }
            
            if (hasChanges) {
                updateUI();
                saveGame();
            }
            
            resourcesPerSecElement.textContent = totalResourcesPerSec.toFixed(1);
        }

        // Update UI
        function updateUI() {
            updateResources();
            updateCapacity();
            updateTagBoosts();
            updateResearch();
            updateFactories();
            updateBuiltFactories();
            updateStats();
            
            if (currentMainTab === 'tech') {
                updateTechTreeView();
            } else if (currentMainTab === 'global-upgrades') {
                updateGlobalUpgradesView();
            }
        }

        // Update Resources Display
        function updateResources() {
            resourcesList.innerHTML = '';
            
            let resourcesToShow = Object.entries(gameData.resources);
            
            if (resourceFilter === 'owned' || !gameState.settings.showAllResources) {
                resourcesToShow = resourcesToShow.filter(([key, resource]) => 
                    gameState.resourcesEverOwned.has(key)
                );
            }
            
            for (const [key, resource] of resourcesToShow) {
                const value = gameState.resources[key];
                const perSec = gameState.resourcesPerSecond[key];
                const type = resource.type;
                const capacity = gameState.capacities[type];
                
                const resourceElement = document.createElement('div');
                resourceElement.className = 'resourceRow';
                
                let capacityClass = '';
                if (value >= capacity * 0.9) {
                    capacityClass = 'resLimitWarn';
                } else if (value >= capacity * 0.7) {
                    capacityClass = 'resLimitNotice';
                }
                
                resourceElement.innerHTML = `
                    <div>
                        <span class="resource-name ${capacityClass}">
                            <span class="resource-type ${type}"></span>
                            ${resource.name}
                        </span>
                        <div style="font-size: 0.8rem; color: #666;">
                            ${perSec >= 0 ? '+' : ''}${perSec.toFixed(1)}/s
                        </div>
                    </div>
                    <div class="resource-value ${capacityClass}">${value.toFixed(1)}</div>
                `;
                
                resourcesList.appendChild(resourceElement);
            }
            
            if (resourcesToShow.length === 0) {
                resourcesList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No resources owned yet</div>';
            }
        }

        // Update Capacity Display
        function updateCapacity() {
            capacityList.innerHTML = '';
            
            for (const [type, capacity] of Object.entries(gameState.capacities)) {
                let used = 0;
                for (const [key, resource] of Object.entries(gameData.resources)) {
                    if (resource.type === type) {
                        used += gameState.resources[key];
                    }
                }
                
                const percentage = Math.min(100, (used / capacity) * 100);
                const typeName = type.charAt(0).toUpperCase() + type.slice(1);
                
                const capacityElement = document.createElement('div');
                capacityElement.innerHTML = `
                    <div style="margin-bottom: 4px;">${typeName}: ${used.toFixed(1)} / ${capacity}</div>
                    <div class="capacity-bar">
                        <div class="capacity-fill" style="width: ${percentage}%"></div>
                    </div>
                `;
                
                capacityList.appendChild(capacityElement);
            }
        }

        // Update Tag Boosts Display
        function updateTagBoosts() {
            tagBoostsList.innerHTML = '';
            
            // Add global upgrades
            let hasBoosts = false;
            
            for (const [upgradeId, upgrade] of Object.entries(gameState.globalUpgradeEffects)) {
                const globalUpgrade = gameData.globalUpgrades[upgradeId];
                if (!globalUpgrade) continue;
                
                hasBoosts = true;
                const boostElement = document.createElement('div');
                boostElement.className = 'boost-item';
                
                let tagsText = globalUpgrade.tags.map(tag => tag === '*' ? 'ALL' : tag).join(', ');
                
                boostElement.innerHTML = `
                    <div class="boost-name">${globalUpgrade.name}</div>
                    <div class="boost-description">Tags: ${tagsText}</div>
                    <div class="boost-description">Global upgrade active</div>
                `;
                
                tagBoostsList.appendChild(boostElement);
            }
            
            // Add tag boosts
            for (const [tag, boosts] of Object.entries(gameState.tagBoosts)) {
                if (boosts.length === 0) continue;
                
                hasBoosts = true;
                let totalOutputMultiplier = 1;
                let totalCycleTimeReduction = 1;
                let totalPowerReduction = 1;
                
                for (const boost of boosts) {
                    if (boost.outputMultiplier) totalOutputMultiplier *= boost.outputMultiplier;
                    if (boost.cycleTimeReduction) totalCycleTimeReduction *= boost.cycleTimeReduction;
                    if (boost.powerReduction) totalPowerReduction *= boost.powerReduction;
                }
                
                const boostElement = document.createElement('div');
                boostElement.className = 'boost-item';
                boostElement.innerHTML = `
                    <div class="boost-name">${tag.toUpperCase()}</div>
                    <div class="boost-description">
                        ${totalOutputMultiplier !== 1 ? `Output: ×${totalOutputMultiplier.toFixed(2)}` : ''}
                        ${totalCycleTimeReduction !== 1 ? ` | Speed: ×${totalCycleTimeReduction.toFixed(2)}` : ''}
                        ${totalPowerReduction !== 1 ? ` | Power: ×${totalPowerReduction.toFixed(2)}` : ''}
                    </div>
                `;
                
                tagBoostsList.appendChild(boostElement);
            }
            
            if (!hasBoosts) {
                tagBoostsList.innerHTML = '<div style="text-align: center; padding: 10px; color: #666;">No active boosts</div>';
            }
        }

        // Update Research Display
        function updateResearch() {
            researchList.innerHTML = '';
            
            for (const [techId, tech] of Object.entries(gameData.techTree)) {
                const isResearched = gameState.techResearched[techId];
                const isResearching = gameState.techResearching === techId;
                
                if (techFilter === 'researched' && !isResearched) continue;
                if (techFilter === 'available' && isResearched) continue;
                if (!gameState.settings.showAllTech && !canResearchTech(techId)) continue;
                
                const canResearch = canResearchTech(techId);
                let canAfford = true;
                
                for (const [resourceKey, amount] of Object.entries(tech.cost)) {
                    if (gameState.resources[resourceKey] < amount) {
                        canAfford = false;
                        break;
                    }
                }
                
                let costText = 'Cost: ';
                for (const [resourceKey, amount] of Object.entries(tech.cost)) {
                    costText += `${amount} ${gameData.resources[resourceKey]?.name || resourceKey}, `;
                }
                costText = costText.slice(0, -2);
                
                let prereqText = '';
                if (tech.prerequisites && tech.prerequisites.length > 0) {
                    prereqText = 'Requires: ' + tech.prerequisites.map(p => gameData.techTree[p].name).join(', ');
                }
                
                const researchElement = document.createElement('div');
                researchElement.style.marginBottom = '15px';
                researchElement.style.paddingBottom = '10px';
                researchElement.style.borderBottom = '1px solid #eee';
                
                if (isResearching) {
                    const progress = (gameState.techResearchProgress / gameState.techResearchTotalTime) * 100;
                    researchElement.innerHTML = `
                        <div style="margin-bottom: 8px;">
                            <div style="font-weight: bold;">${tech.name}</div>
                            <div style="font-size: 0.9rem; color: #666;">${tech.description}</div>
                            <div style="font-size: 0.8rem; margin-top: 4px;">Research in progress...</div>
                            <div class="research-progress">
                                <div class="research-progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <div style="font-size: 0.8rem; text-align: right;">
                                ${Math.min(gameState.techResearchProgress, gameState.techResearchTotalTime).toFixed(1)} / ${gameState.techResearchTotalTime}s
                            </div>
                        </div>
                    `;
                } else if (isResearched) {
                    researchElement.innerHTML = `
                        <div style="margin-bottom: 8px;">
                            <div style="font-weight: bold; color: green;">${tech.name} ✓</div>
                            <div style="font-size: 0.9rem; color: #666;">${tech.description}</div>
                            <div style="font-size: 0.8rem; color: green;">Researched</div>
                        </div>
                    `;
                } else {
                    researchElement.innerHTML = `
                        <div style="margin-bottom: 8px;">
                            <div style="font-weight: bold; color: ${canResearch ? 'black' : '#999'}">${tech.name}</div>
                            <div style="font-size: 0.9rem; color: ${canResearch ? '#666' : '#999'}">${tech.description}</div>
                            <div style="font-size: 0.8rem; margin-top: 4px;">${costText}</div>
                            <div style="font-size: 0.8rem;">Research time: ${tech.researchTime}s</div>
                            ${prereqText ? `<div style="font-size: 0.8rem; color: ${canResearch ? '#666' : '#f00'}">${prereqText}</div>` : ''}
                        </div>
                    `;
                    
                    const button = document.createElement('button');
                    button.className = `btn ${canResearch && canAfford ? 'bldEnabled' : 'disabled'}`;
                    button.textContent = `Research ${tech.name}`;
                    button.disabled = !canResearch || !canAfford;
                    button.title = `${tech.description}\n${costText}`;
                    button.onclick = () => startResearchTech(techId);
                    
                    researchElement.appendChild(button);
                }
                
                researchList.appendChild(researchElement);
            }
            
            if (researchList.children.length === 0) {
                researchList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No research available</div>';
            }
        }

        // Update Factories Display
        function updateFactories() {
            factoriesList.innerHTML = '';
            
            for (const [key, factory] of Object.entries(gameData.factories)) {
                if (!gameState.researchedFactories[key]) continue;
                
                let canBuild = true;
                
                for (const [resourceKey, amount] of Object.entries(factory.buildCost)) {
                    if (gameState.resources[resourceKey] < amount) {
                        canBuild = false;
                        break;
                    }
                }
                
                let buildCostText = 'Cost: ';
                for (const [resourceKey, amount] of Object.entries(factory.buildCost)) {
                    buildCostText += `${amount} ${gameData.resources[resourceKey]?.name || resourceKey}, `;
                }
                buildCostText = buildCostText.slice(0, -2);
                
                // Tags display
                let tagsHtml = '<div class="factory-tags">';
                if (factory.tags && factory.tags.length > 0) {
                    factory.tags.forEach(tag => {
                        tagsHtml += `<span class="factory-tag">${tag}</span>`;
                    });
                }
                tagsHtml += '</div>';
                
                const factoryElement = document.createElement('div');
                factoryElement.style.marginBottom = '15px';
                
                factoryElement.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <div style="font-weight: bold;">${factory.name} ${factory.flexible ? '⚙️' : ''}</div>
                        <div style="font-size: 0.9rem; color: #666;">${factory.description}</div>
                        ${factory.flexible ? '<div style="font-size: 0.8rem; color: #2196F3;">Flexible Factory</div>' : ''}
                        ${tagsHtml}
                        <div style="font-size: 0.8rem; margin-top: 4px;">Build Cost: ${buildCostText}</div>
                    </div>
                `;
                
                const button = document.createElement('button');
                button.className = `btn ${canBuild ? 'bldEnabled' : 'disabled'}`;
                button.textContent = `Build ${factory.name} (${gameState.builtFactories[key]})`;
                button.disabled = !canBuild;
                button.onclick = () => buildFactory(key);
                
                factoryElement.appendChild(button);
                factoriesList.appendChild(factoryElement);
            }
        }

        // Update tag filter
        function updateTagFilter() {
            tagFilterContainer.innerHTML = '';
            
            // Get all unique tags from built factories
            const allTags = new Set();
            for (const [factoryKey, factory] of Object.entries(gameData.factories)) {
                if (gameState.builtFactories[factoryKey] > 0 && factory.tags) {
                    factory.tags.forEach(tag => allTags.add(tag));
                }
            }
            
            if (allTags.size === 0) return;
            
            const filterDiv = document.createElement('div');
            filterDiv.className = 'tag-filter-container';
            
            // Add "All" button
            const allBtn = document.createElement('button');
            allBtn.className = `tag-filter-btn ${gameState.selectedTagFilter === null ? 'active' : ''}`;
            allBtn.textContent = 'All';
            allBtn.onclick = () => {
                gameState.selectedTagFilter = null;
                updateBuiltFactories();
            };
            filterDiv.appendChild(allBtn);
            
            // Add tag buttons
            Array.from(allTags).sort().forEach(tag => {
                const tagBtn = document.createElement('button');
                tagBtn.className = `tag-filter-btn ${gameState.selectedTagFilter === tag ? 'active' : ''}`;
                tagBtn.textContent = tag;
                tagBtn.onclick = () => {
                    gameState.selectedTagFilter = tag;
                    updateBuiltFactories();
                };
                filterDiv.appendChild(tagBtn);
            });
            
            tagFilterContainer.appendChild(filterDiv);
        }

        // Update Built Factories Display - SINGLE PANEL VIEW
        function updateBuiltFactories() {
            updateTagFilter();
            
            builtFactories.innerHTML = '';
            
            let hasFactories = false;
            
            for (const [factoryKey, factory] of Object.entries(gameData.factories)) {
                const builtCount = gameState.builtFactories[factoryKey];
                const activeCount = gameState.activeFactories[factoryKey];
                
                if (builtCount === 0) continue;
                
                // Check tag filter
                if (gameState.selectedTagFilter && (!factory.tags || !factory.tags.includes(gameState.selectedTagFilter))) {
                    continue;
                }
                
                hasFactories = true;
                
                const factoryPanel = document.createElement('div');
                factoryPanel.className = `factory-panel ${gameState.expandedFactoryPanels.has(factoryKey) ? 'expanded' : ''}`;
                factoryPanel.dataset.factoryKey = factoryKey;
                
                // Calculate allocations summary for collapsed view
                let allocationSummary = '';
                if (factory.flexible) {
                    const allocations = gameState.factoryAllocations[factoryKey] || {};
                    const modeCounts = [];
                    
                    for (let i = 0; i < factory.productionModes.length; i++) {
                        const mode = factory.productionModes[i];
                        const allocation = allocations[mode.id];
                        if (allocation && allocation.count > 0) {
                            modeCounts.push(`${allocation.count}× ${mode.name}`);
                        }
                    }
                    
                    const totalAllocated = Object.values(allocations).reduce((sum, alloc) => sum + (alloc.count || 0), 0);
                    const inactive = activeCount - totalAllocated;
                    
                    if (modeCounts.length > 0) {
                        allocationSummary = ` | Allocated: ${modeCounts.join(', ')}`;
                        if (inactive > 0) {
                            allocationSummary += ` (${inactive} inactive)`;
                        }
                    }
                }
                
                // Tags display
                let tagsHtml = '<div class="factory-tags">';
                if (factory.tags && factory.tags.length > 0) {
                    factory.tags.forEach(tag => {
                        tagsHtml += `<span class="factory-tag">${tag}</span>`;
                    });
                }
                tagsHtml += '</div>';
                
                // Header - shows when collapsed
                const header = document.createElement('div');
                header.className = 'factory-panel-header';
                header.innerHTML = `
                    <div class="factory-header-info">
                        <div style="font-weight: bold; margin-bottom: 4px;">${factory.name}</div>
                        <div class="factory-header-stats">
                            <span>Built: ${builtCount}</span>
                            <span>Active: ${activeCount}</span>
                            <span>Inactive: ${builtCount - activeCount}</span>
                            ${allocationSummary ? `<span>${allocationSummary}</span>` : ''}
                        </div>
                        ${tagsHtml}
                    </div>
                    <span class="collapse-icon">▶</span>
                `;
                header.onclick = () => {
                    const factoryKey = factoryPanel.dataset.factoryKey;
                    if (gameState.expandedFactoryPanels.has(factoryKey)) {
                        gameState.expandedFactoryPanels.delete(factoryKey);
                    } else {
                        gameState.expandedFactoryPanels.add(factoryKey);
                    }
                    updateBuiltFactories();
                };
                
                // Content - shows when expanded (FULL CONFIGURATION)
                const content = document.createElement('div');
                content.className = 'factory-panel-content';
                
                // Build content based on factory type
                if (factory.flexible) {
                    // Flexible factory: Show activation controls AND allocation configuration
                    content.innerHTML = createFlexibleFactoryContent(factoryKey, factory);
                } else {
                    // Non-flexible factory: Show only activation controls
                    content.innerHTML = createSimpleFactoryContent(factoryKey, factory);
                }
                
                factoryPanel.appendChild(header);
                factoryPanel.appendChild(content);
                builtFactories.appendChild(factoryPanel);
                
                // Add event listeners for control buttons
                setTimeout(() => {
                    content.querySelectorAll('.control-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const factoryKey = this.getAttribute('data-factory');
                            const change = this.getAttribute('data-change');
                            
                            if (change === 'all-up') {
                                activateFactory(factoryKey, 'all');
                            } else if (change === 'all-down') {
                                activateFactory(factoryKey, 0);
                            } else {
                                activateFactory(factoryKey, parseInt(change));
                            }
                        });
                    });
                    
                    // Add event listeners for allocation controls
                    content.querySelectorAll('.number-input').forEach(input => {
                        input.addEventListener('change', function() {
                            const factoryKey = this.getAttribute('data-factory');
                            const modeId = this.getAttribute('data-mode');
                            const newValue = parseInt(this.value) || 0;
                            const totalActive = gameState.activeFactories[factoryKey];
                            const clampedValue = Math.max(0, Math.min(newValue, totalActive));
                            setAllocationCount(factoryKey, modeId, clampedValue);
                        });
                    });
                    
                    // Add event listeners for upgrade toggles
                    content.querySelectorAll('.upgrade-toggle').forEach(toggle => {
                        toggle.addEventListener('change', function() {
                            const factoryKey = this.getAttribute('data-factory');
                            const modeId = this.getAttribute('data-mode');
                            const upgradeId = this.getAttribute('data-upgrade');
                            toggleUpgrade(factoryKey, modeId, upgradeId, this.checked);
                        });
                    });
                }, 0);
            }
            
            if (!hasFactories) {
                builtFactories.innerHTML = '<div class="no-factories-message">No factories built yet</div>';
            }
        }

        // Create content for flexible factory (with allocation controls)
        function createFlexibleFactoryContent(factoryKey, factory) {
            const allocations = gameState.factoryAllocations[factoryKey] || {};
            const totalActive = gameState.activeFactories[factoryKey];
            const totalBuilt = gameState.builtFactories[factoryKey];
            
            let html = `
                <div class="factory-controls-panel">
                    <div class="control-section">
                        <div class="control-section-title">Activation Controls</div>
                        <div class="factory-controls">
                            <div class="control-group">
                                <button class="control-btn arrow-btn down" data-factory="${factoryKey}" data-change="-1">-1</button>
                                <button class="control-btn arrow-btn double down" data-factory="${factoryKey}" data-change="-10">-10</button>
                                <div class="factory-count" id="count-${factoryKey}">${totalActive}</div>
                                <button class="control-btn arrow-btn" data-factory="${factoryKey}" data-change="1">+1</button>
                                <button class="control-btn arrow-btn double" data-factory="${factoryKey}" data-change="10">+10</button>
                            </div>
                        </div>
                        <div class="factory-controls" style="margin-top: 4px;">
                            <button class="control-btn" data-factory="${factoryKey}" data-change="all-down" style="flex: 1;">All Off</button>
                            <button class="control-btn" data-factory="${factoryKey}" data-change="all-up" style="flex: 1;">All On</button>
                        </div>
                    </div>
                </div>
                
                <div class="allocation-container">
                    <div class="allocation-section-title">Production Allocation</div>
                    <div style="margin-bottom: 10px; font-size: 0.9rem; color: #666;">
                        Active: ${totalActive} | Available for allocation: ${totalActive}
                    </div>
            `;
            
            // Allocation controls for each mode
            for (const mode of factory.productionModes) {
                const allocation = allocations[mode.id] || { count: 0, selectedUpgrades: [] };
                const currentAllocation = allocation.count || 0;
                
                html += `
                    <div class="mode-container">
                        <div class="mode-header">
                            <div class="mode-title">${mode.name}</div>
                            <div class="allocation-controls">
                                <button class="input-btn" onclick="changeAllocation('${factoryKey}', '${mode.id}', -1)">−</button>
                                <input type="number" class="number-input" data-factory="${factoryKey}" data-mode="${mode.id}" 
                                       value="${currentAllocation}" min="0" max="${totalActive}">
                                <button class="input-btn" onclick="changeAllocation('${factoryKey}', '${mode.id}', 1)">+</button>
                            </div>
                        </div>
                        <div class="mode-details">${mode.description}</div>
                        <div class="mode-io">
                            <div class="mode-inputs">
                                <div class="io-title">Inputs (per cycle):</div>
                                ${Object.entries(mode.inputs).map(([k, v]) => 
                                    `<div class="io-item">${v} ${gameData.resources[k]?.name || k}</div>`
                                ).join('') || '<div class="io-item">None</div>'}
                            </div>
                            <div class="mode-outputs">
                                <div class="io-title">Outputs (per cycle):</div>
                                ${Object.entries(mode.outputs).map(([k, v]) => 
                                    `<div class="io-item">${v} ${gameData.resources[k]?.name || k}</div>`
                                ).join('')}
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                            Cycle: ${mode.cycleTime}s | Base Power: ${mode.basePower}/cycle
                        </div>
                `;
                
                // Upgrades section
                if (mode.availableUpgrades && mode.availableUpgrades.length > 0) {
                    html += `
                        <div class="upgrades-container">
                            <div class="boost-section-title">Available Upgrades</div>
                    `;
                    
                    for (const upgradeId of mode.availableUpgrades) {
                        const upgrade = factory.upgrades[upgradeId];
                        if (!upgrade) continue;
                        
                        const isSelected = allocation.selectedUpgrades && allocation.selectedUpgrades.includes(upgradeId);
                        
                        // Upgrade cost text
                        let costText = '';
                        for (const [resource, amount] of Object.entries(upgrade.requiredInputs)) {
                            costText += `${amount}/cycle ${gameData.resources[resource]?.name || resource}, `;
                        }
                        if (costText) costText = costText.slice(0, -2);
                        
                        html += `
                            <div class="boost-option ${isSelected ? 'selected' : ''}" style="margin-bottom: 8px; padding: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-weight: bold;">${upgrade.name}</div>
                                    <label class="toggle-switch" style="transform: scale(0.8);">
                                        <input type="checkbox" class="upgrade-toggle" 
                                               data-factory="${factoryKey}" 
                                               data-mode="${mode.id}"
                                               data-upgrade="${upgradeId}"
                                               ${isSelected ? 'checked' : ''}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="config-details">${upgrade.description}</div>
                                <div class="config-details">Cost: ${costText}</div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                }
                
                html += `</div>`;
            }
            
            html += `
                </div>
                <button class="btn demolish-btn" style="margin-top: 15px; width: 100%;" onclick="demolishFactory('${factoryKey}')">
                    Demolish Factory
                </button>
            `;
            
            return html;
        }

        // Create content for simple factory (just activation controls)
        function createSimpleFactoryContent(factoryKey, factory) {
            const totalActive = gameState.activeFactories[factoryKey];
            const totalBuilt = gameState.builtFactories[factoryKey];
            
            return `
                <div class="factory-controls-panel">
                    <div class="control-section">
                        <div class="control-section-title">Activation Controls</div>
                        <div class="factory-controls">
                            <div class="control-group">
                                <button class="control-btn arrow-btn down" data-factory="${factoryKey}" data-change="-1">-1</button>
                                <button class="control-btn arrow-btn double down" data-factory="${factoryKey}" data-change="-10">-10</button>
                                <div class="factory-count" id="count-${factoryKey}">${totalActive}</div>
                                <button class="control-btn arrow-btn" data-factory="${factoryKey}" data-change="1">+1</button>
                                <button class="control-btn arrow-btn double" data-factory="${factoryKey}" data-change="10">+10</button>
                            </div>
                        </div>
                        <div class="factory-controls" style="margin-top: 4px;">
                            <button class="control-btn" data-factory="${factoryKey}" data-change="all-down" style="flex: 1;">All Off</button>
                            <button class="control-btn" data-factory="${factoryKey}" data-change="all-up" style="flex: 1;">All On</button>
                        </div>
                    </div>
                </div>
                <button class="btn demolish-btn" style="margin-top: 15px; width: 100%;" onclick="demolishFactory('${factoryKey}')">
                    Demolish Factory
                </button>
            `;
        }

        // Change allocation count
        function changeAllocation(factoryKey, modeId, change) {
            const factory = gameData.factories[factoryKey];
            if (!factory || !factory.flexible) return;
            
            const allocations = gameState.factoryAllocations[factoryKey] || {};
            const currentAllocation = allocations[modeId] || { count: 0, selectedUpgrades: [] };
            const totalActive = gameState.activeFactories[factoryKey];
            
            // Calculate total currently allocated
            let totalAllocated = 0;
            for (const alloc of Object.values(allocations)) {
                totalAllocated += alloc.count || 0;
            }
            
            // Calculate new value
            let newCount = currentAllocation.count + change;
            newCount = Math.max(0, newCount);
            
            // Can't allocate more than active factories
            if (totalAllocated - currentAllocation.count + newCount > totalActive) {
                newCount = Math.max(0, totalActive - (totalAllocated - currentAllocation.count));
            }
            
            setAllocationCount(factoryKey, modeId, newCount);
        }

        // Set allocation count
        function setAllocationCount(factoryKey, modeId, count) {
            const allocations = gameState.factoryAllocations[factoryKey] || {};
            
            if (count > 0) {
                if (!allocations[modeId]) {
                    allocations[modeId] = { count: 0, selectedUpgrades: [] };
                }
                allocations[modeId].count = count;
            } else {
                if (allocations[modeId]) {
                    allocations[modeId].count = 0;
                }
            }
            
            gameState.factoryAllocations[factoryKey] = allocations;
            updateUI();
            saveGame();
        }

        // Toggle upgrade
        function toggleUpgrade(factoryKey, modeId, upgradeId, enabled) {
            const allocations = gameState.factoryAllocations[factoryKey] || {};
            if (!allocations[modeId]) {
                allocations[modeId] = { count: 0, selectedUpgrades: [] };
            }
            
            if (enabled) {
                if (!allocations[modeId].selectedUpgrades.includes(upgradeId)) {
                    allocations[modeId].selectedUpgrades.push(upgradeId);
                }
            } else {
                allocations[modeId].selectedUpgrades = allocations[modeId].selectedUpgrades.filter(id => id !== upgradeId);
            }
            
            gameState.factoryAllocations[factoryKey] = allocations;
            updateUI();
            saveGame();
        }

        // Update Statistics
        function updateStats() {
            let total = 0;
            let active = 0;
            
            for (const [key, count] of Object.entries(gameState.builtFactories)) {
                total += count;
                active += gameState.activeFactories[key];
            }
            
            totalFactoriesElement.textContent = total;
            activeFactoriesElement.textContent = active;
        }

        // Build a factory
        function buildFactory(factoryKey) {
            const factory = gameData.factories[factoryKey];
            
            // Check costs
            for (const [resourceKey, amount] of Object.entries(factory.buildCost)) {
                if (gameState.resources[resourceKey] < amount) {
                    showNotification(`Not enough ${gameData.resources[resourceKey]?.name || resourceKey}`);
                    return;
                }
            }
            
            // Deduct costs
            for (const [resourceKey, amount] of Object.entries(factory.buildCost)) {
                gameState.resources[resourceKey] -= amount;
            }
            
            // Add factory
            gameState.builtFactories[factoryKey]++;
            
            // Auto activate
            if (gameState.settings.autoActivateFactories) {
                gameState.activeFactories[factoryKey]++;
            }
            
            // Add capacity
            for (const [type, amount] of Object.entries(factory.capacityAdditions)) {
                gameState.capacities[type] += amount;
            }
            
            showNotification(`${factory.name} built!`);
            updateUI();
            saveGame();
        }

        // Activate/Deactivate factories
        function activateFactory(factoryKey, change) {
            const currentActive = gameState.activeFactories[factoryKey];
            const totalBuilt = gameState.builtFactories[factoryKey];
            
            if (change === 'all') {
                gameState.activeFactories[factoryKey] = totalBuilt;
            } else if (change === 0) {
                gameState.activeFactories[factoryKey] = 0;
                // Clear allocations when deactivating all
                if (gameData.factories[factoryKey].flexible) {
                    gameState.factoryAllocations[factoryKey] = {};
                }
            } else {
                const newActive = Math.max(0, Math.min(totalBuilt, currentActive + change));
                gameState.activeFactories[factoryKey] = newActive;
                
                // Adjust allocations if reducing active count
                if (newActive < currentActive && gameData.factories[factoryKey].flexible) {
                    const allocations = gameState.factoryAllocations[factoryKey] || {};
                    let totalAllocated = 0;
                    for (const alloc of Object.values(allocations)) {
                        totalAllocated += alloc.count || 0;
                    }
                    
                    if (totalAllocated > newActive) {
                        // Reduce allocations proportionally
                        const ratio = newActive / totalAllocated;
                        for (const modeId in allocations) {
                            allocations[modeId].count = Math.floor(allocations[modeId].count * ratio);
                            if (allocations[modeId].count === 0) {
                                allocations[modeId].count = 0;
                            }
                        }
                        gameState.factoryAllocations[factoryKey] = allocations;
                    }
                }
            }
            
            updateUI();
            saveGame();
        }

        // Demolish factory
        function demolishFactory(factoryKey) {
            const factory = gameData.factories[factoryKey];
            const builtCount = gameState.builtFactories[factoryKey];
            
            if (builtCount === 0) return;
            
            if (!confirm(`Demolish one ${factory.name}? You'll get back 50% of the build cost.`)) {
                return;
            }
            
            // Remove factory
            gameState.builtFactories[factoryKey]--;
            
            // Adjust active count
            if (gameState.activeFactories[factoryKey] > gameState.builtFactories[factoryKey]) {
                gameState.activeFactories[factoryKey] = gameState.builtFactories[factoryKey];
            }
            
            // Clear allocations if no longer built
            if (gameState.builtFactories[factoryKey] === 0) {
                gameState.factoryAllocations[factoryKey] = {};
            }
            
            // Refund 50% of build cost
            for (const [resourceKey, amount] of Object.entries(factory.buildCost)) {
                gameState.resources[resourceKey] += Math.floor(amount * 0.5);
            }
            
            // Remove capacity
            for (const [type, amount] of Object.entries(factory.capacityAdditions)) {
                gameState.capacities[type] = Math.max(gameData.capacities[type], gameState.capacities[type] - amount);
            }
            
            showNotification(`${factory.name} demolished. 50% of resources refunded.`);
            updateUI();
            saveGame();
        }

        // Show notification
        function showNotification(message) {
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Save game
        function saveGame() {
            const saveState = {
                ...gameState,
                resourcesEverOwned: Array.from(gameState.resourcesEverOwned),
                expandedFactoryPanels: Array.from(gameState.expandedFactoryPanels),
                antiCheat: {
                    ...gameState.antiCheat,
                    lastTickTime: Date.now()
                }
            };
            
            const gameStateString = JSON.stringify(saveState);
            const encoded = btoa(gameStateString);
            
            const d = new Date();
            d.setTime(d.getTime() + (30 * 24 * 60 * 60 * 1000));
            const expires = "expires=" + d.toUTCString();
            document.cookie = "factoryGame=" + encoded + ";" + expires + ";path=/";
        }

        // Load game
        function loadGame() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('factoryGame='))
                ?.split('=')[1];
                
            if (cookieValue) {
                try {
                    const decoded = atob(cookieValue);
                    const savedState = JSON.parse(decoded);
                    
                    if (savedState.version === gameState.version) {
                        if (savedState.resourcesEverOwned) {
                            gameState.resourcesEverOwned = new Set(savedState.resourcesEverOwned);
                        }
                        
                        if (savedState.expandedFactoryPanels) {
                            gameState.expandedFactoryPanels = new Set(savedState.expandedFactoryPanels);
                        }
                        
                        Object.assign(gameState, savedState);
                        
                        // Ensure all arrays exist
                        for (const key in gameData.factories) {
                            if (!gameState.factoryAllocations[key]) gameState.factoryAllocations[key] = {};
                        }
                        
                        gameState.antiCheat.lastTickTime = Date.now();
                        AntiCheat.resetViolations();
                        
                        showNotification("Game loaded!");
                        updateUI();
                    }
                } catch (e) {
                    console.error("Failed to load game:", e);
                }
            }
        }

        // Export game
        function exportGame() {
            const saveState = {
                ...gameState,
                resourcesEverOwned: Array.from(gameState.resourcesEverOwned),
                expandedFactoryPanels: Array.from(gameState.expandedFactoryPanels)
            };
            
            const gameStateString = JSON.stringify(saveState);
            const encoded = btoa(gameStateString);
            
            navigator.clipboard.writeText(encoded).then(() => {
                showNotification("Game data copied to clipboard!");
            });
        }

        // Import game
        function importGame() {
            document.getElementById('import-modal').style.display = 'block';
        }

        // Confirm import
        function confirmImport() {
            const importData = document.getElementById('import-data').value.trim();
            
            if (!importData) {
                showNotification("No import data provided!");
                document.getElementById('import-modal').style.display = 'none';
                return;
            }
            
            try {
                const decoded = atob(importData);
                const importedState = JSON.parse(decoded);
                
                if (importedState.version === gameState.version) {
                    if (importedState.resourcesEverOwned) {
                        gameState.resourcesEverOwned = new Set(importedState.resourcesEverOwned);
                    }
                    
                    if (importedState.expandedFactoryPanels) {
                        gameState.expandedFactoryPanels = new Set(importedState.expandedFactoryPanels);
                    }
                    
                    Object.assign(gameState, importedState);
                    
                    for (const key in gameData.factories) {
                        if (!gameState.factoryAllocations[key]) gameState.factoryAllocations[key] = {};
                    }
                    
                    gameState.antiCheat.lastTickTime = Date.now();
                    AntiCheat.resetViolations();
                    
                    showNotification("Game data imported successfully!");
                    updateUI();
                    saveGame();
                } else {
                    showNotification("Import failed: Version mismatch!");
                }
            } catch (e) {
                showNotification("Import failed: Invalid data!");
            }
            
            document.getElementById('import-modal').style.display = 'none';
        }

        // Cancel import
        function cancelImport() {
            document.getElementById('import-modal').style.display = 'none';
        }

        // Open settings
        function openSettings() {
            const modal = document.getElementById('settings-modal');
            const settings = gameState.settings;
            
            document.getElementById('auto-activate-toggle').checked = settings.autoActivateFactories;
            document.getElementById('show-all-resources-toggle').checked = settings.showAllResources;
            document.getElementById('show-all-tech-toggle').checked = settings.showAllTech;
            
            modal.style.display = 'block';
        }

        // Close settings
        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        // Save settings
        function saveSettings() {
            gameState.settings.autoActivateFactories = document.getElementById('auto-activate-toggle').checked;
            gameState.settings.showAllResources = document.getElementById('show-all-resources-toggle').checked;
            gameState.settings.showAllTech = document.getElementById('show-all-tech-toggle').checked;
            
            saveGame();
            closeSettings();
            showNotification('Settings saved!');
        }

        // Reset game
        function resetGame() {
            if (confirm("Are you sure you want to reset the game? All progress will be lost.")) {
                document.cookie = "factoryGame=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                initGame();
                showNotification("Game reset!");
            }
        }

        // Initialize game
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
